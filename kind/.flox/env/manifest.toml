## Flox Environment Manifest -----------------------------------------
##
##   _Everything_ you need to know about the _manifest_ is here:
##
##               https://flox.dev/docs/concepts/manifest
##
## -------------------------------------------------------------------
# Flox manifest version managed by Flox CLI
version = 1


## Install Packages --------------------------------------------------
[install]
kind.pkg-path = "kind"
kubectl.pkg-path = "kubectl"
curl.pkg-path = "curl"
bat.pkg-path = "bat"
jq.pkg-path = "jq"
coreutils.pkg-path = "coreutils"
coreutils.pkg-group = "darwin-tools"


## Environment Variables ---------------------------------------------
[vars]
KIND_CONFIG_DIR = "$FLOX_ENV_CACHE/kind-config"
KIND_LOG_DIR = "$FLOX_ENV_CACHE/kind-logs"
KIND_DATA_DIR = "$FLOX_ENV_CACHE/kind-data"


## Activation Hook ---------------------------------------------------
[hook]
on-activate = '''
# Create required directories
mkdir -p "$FLOX_ENV_CACHE/kind-config"
mkdir -p "$FLOX_ENV_CACHE/kind-logs"
mkdir -p "$FLOX_ENV_CACHE/kind-data"

# Runtime-configurable variables with defaults
export KIND_CLUSTER_NAME="${KIND_CLUSTER_NAME:-kind}"
export KIND_CONFIG_FILE="${KIND_CONFIG_FILE:-$KIND_CONFIG_DIR/cluster.yaml}"
export KIND_KUBECONFIG="${KIND_KUBECONFIG:-$KIND_DATA_DIR/kubeconfig}"
export KIND_IMAGE="${KIND_IMAGE:-}"

# Generate default KIND config if not exists
if [ ! -f "$KIND_CONFIG_FILE" ]; then
    cat > "$KIND_CONFIG_FILE" << 'EOF'
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
- role: worker
EOF
fi

# Fetch README if missing
README_FILE="$FLOX_ENV_PROJECT/README.md"
if [ ! -s "$README_FILE" ]; then
    curl -fsSL "https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/kind-headless/README.md" -o "$README_FILE" 2>/dev/null || true
fi

# Display minimal info
echo ""
echo "✅ KIND environment ready (headless mode)"
echo ""
echo "Cluster Name: $KIND_CLUSTER_NAME"
echo "Config File:  $KIND_CONFIG_FILE"
echo ""
echo "Start cluster: flox activate -s"
echo "Check status:  flox services status"
echo "Show info:     kind-info"
echo "For help:      helpf"
echo ""
'''


## Profile script ----------------------------------------------------
[profile]
bash = '''
kind-info() {
    echo "KIND Cluster (Headless Mode)"
    echo ""
    echo "Cluster Name: $KIND_CLUSTER_NAME"
    echo "Config File:  $KIND_CONFIG_FILE"
    echo "Kubeconfig:   $KIND_KUBECONFIG"
    echo ""
    echo "Commands:"
    echo "  flox activate -s        Start KIND cluster service"
    echo "  flox services status    Check service status"
    echo "  flox services logs kind View service logs"
    echo "  kubectl cluster-info    Show cluster information"
    echo "  kind get clusters       List KIND clusters"
    echo ""
    echo "Runtime Configuration:"
    echo "  KIND_CLUSTER_NAME       Default: $KIND_CLUSTER_NAME"
    echo "  KIND_CONFIG_FILE        Default: $KIND_CONFIG_FILE"
    echo "  KIND_KUBECONFIG         Default: $KIND_KUBECONFIG"
    echo "  KIND_IMAGE              Default: (latest)"
    echo ""
    echo "Example:"
    echo "  KIND_CLUSTER_NAME=dev KIND_CONFIG_FILE=./my-config.yaml flox activate -s"
}

helpf() {
  local README_FILE="$FLOX_ENV_PROJECT/README.md"
  local README_URL="https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/kind-headless/README.md"

  if [ "$1" = "--help" ]; then
    echo "Usage: helpf [OPTIONS]"
    echo ""
    echo "View environment documentation"
    echo ""
    echo "Options:"
    echo "  --force    Force download fresh copy from GitHub"
    echo "  --help     Show this help message"
    echo ""
    echo "The README is cached locally and only downloaded if missing."
    return 0
  fi

  if [ "$1" = "--force" ]; then
    echo "Fetching latest README.md from GitHub..."
    if curl -fsSL "$README_URL" -o "$README_FILE"; then
      echo "✓ Downloaded README.md"
    else
      echo "✗ Failed to download README.md"
      return 1
    fi
  elif [ ! -f "$README_FILE" ]; then
    echo "README.md not found, downloading..."
    if curl -fsSL "$README_URL" -o "$README_FILE"; then
      echo "✓ Downloaded README.md"
    else
      echo "✗ Failed to download README.md"
      return 1
    fi
  fi

  if [ -f "$README_FILE" ]; then
    bat --style=auto --paging=always "$README_FILE"
  else
    echo "✗ README.md not found at $README_FILE"
    return 1
  fi
}
'''

zsh = '''
kind-info() {
    echo "KIND Cluster (Headless Mode)"
    echo ""
    echo "Cluster Name: $KIND_CLUSTER_NAME"
    echo "Config File:  $KIND_CONFIG_FILE"
    echo "Kubeconfig:   $KIND_KUBECONFIG"
    echo ""
    echo "Commands:"
    echo "  flox activate -s        Start KIND cluster service"
    echo "  flox services status    Check service status"
    echo "  flox services logs kind View service logs"
    echo "  kubectl cluster-info    Show cluster information"
    echo "  kind get clusters       List KIND clusters"
    echo ""
    echo "Runtime Configuration:"
    echo "  KIND_CLUSTER_NAME       Default: $KIND_CLUSTER_NAME"
    echo "  KIND_CONFIG_FILE        Default: $KIND_CONFIG_FILE"
    echo "  KIND_KUBECONFIG         Default: $KIND_KUBECONFIG"
    echo "  KIND_IMAGE              Default: (latest)"
    echo ""
    echo "Example:"
    echo "  KIND_CLUSTER_NAME=dev KIND_CONFIG_FILE=./my-config.yaml flox activate -s"
}

helpf() {
  local README_FILE="$FLOX_ENV_PROJECT/README.md"
  local README_URL="https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/kind-headless/README.md"

  if [ "$1" = "--help" ]; then
    echo "Usage: helpf [OPTIONS]"
    echo ""
    echo "View environment documentation"
    echo ""
    echo "Options:"
    echo "  --force    Force download fresh copy from GitHub"
    echo "  --help     Show this help message"
    echo ""
    echo "The README is cached locally and only downloaded if missing."
    return 0
  fi

  if [ "$1" = "--force" ]; then
    echo "Fetching latest README.md from GitHub..."
    if curl -fsSL "$README_URL" -o "$README_FILE"; then
      echo "✓ Downloaded README.md"
    else
      echo "✗ Failed to download README.md"
      return 1
    fi
  elif [ ! -f "$README_FILE" ]; then
    echo "README.md not found, downloading..."
    if curl -fsSL "$README_URL" -o "$README_FILE"; then
      echo "✓ Downloaded README.md"
    else
      echo "✗ Failed to download README.md"
      return 1
    fi
  fi

  if [ -f "$README_FILE" ]; then
    bat --style=auto --paging=always "$README_FILE"
  else
    echo "✗ README.md not found at $README_FILE"
    return 1
  fi
}
'''

fish = '''
function kind-info
    echo "KIND Cluster (Headless Mode)"
    echo ""
    echo "Cluster Name: $KIND_CLUSTER_NAME"
    echo "Config File:  $KIND_CONFIG_FILE"
    echo "Kubeconfig:   $KIND_KUBECONFIG"
    echo ""
    echo "Commands:"
    echo "  flox activate -s        Start KIND cluster service"
    echo "  flox services status    Check service status"
    echo "  flox services logs kind View service logs"
    echo "  kubectl cluster-info    Show cluster information"
    echo "  kind get clusters       List KIND clusters"
    echo ""
    echo "Runtime Configuration:"
    echo "  KIND_CLUSTER_NAME       Default: $KIND_CLUSTER_NAME"
    echo "  KIND_CONFIG_FILE        Default: $KIND_CONFIG_FILE"
    echo "  KIND_KUBECONFIG         Default: $KIND_KUBECONFIG"
    echo "  KIND_IMAGE              Default: (latest)"
    echo ""
    echo "Example:"
    echo "  KIND_CLUSTER_NAME=dev KIND_CONFIG_FILE=./my-config.yaml flox activate -s"
end

function helpf
  set README_FILE "$FLOX_ENV_PROJECT/README.md"
  set README_URL "https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/kind-headless/README.md"

  if test "$argv[1]" = "--help"
    echo "Usage: helpf [OPTIONS]"
    echo ""
    echo "View environment documentation"
    echo ""
    echo "Options:"
    echo "  --force    Force download fresh copy from GitHub"
    echo "  --help     Show this help message"
    echo ""
    echo "The README is cached locally and only downloaded if missing."
    return 0
  end

  if test "$argv[1]" = "--force"
    echo "Fetching latest README.md from GitHub..."
    if curl -fsSL "$README_URL" -o "$README_FILE"
      echo "✓ Downloaded README.md"
    else
      echo "✗ Failed to download README.md"
      return 1
    end
  else if not test -f "$README_FILE"
    echo "README.md not found, downloading..."
    if curl -fsSL "$README_URL" -o "$README_FILE"
      echo "✓ Downloaded README.md"
    else
      echo "✗ Failed to download README.md"
      return 1
    end
  end

  if test -f "$README_FILE"
    bat --style=auto --paging=always "$README_FILE"
  else
    echo "✗ README.md not found at $README_FILE"
    return 1
  end
end
'''


## Services ----------------------------------------------------------
[services]
kind.command = '''
mkdir -p "$KIND_LOG_DIR"
mkdir -p "$KIND_DATA_DIR"

# Log startup
echo "=== KIND Service Startup ===" > "$KIND_LOG_DIR/service.log"
echo "Starting at $(date)" >> "$KIND_LOG_DIR/service.log"
echo "KIND_CLUSTER_NAME = $KIND_CLUSTER_NAME" >> "$KIND_LOG_DIR/service.log"
echo "KIND_CONFIG_FILE = $KIND_CONFIG_FILE" >> "$KIND_LOG_DIR/service.log"

# Check if cluster already exists
if kind get clusters 2>/dev/null | grep -q "^${KIND_CLUSTER_NAME}$"; then
    echo "Cluster '$KIND_CLUSTER_NAME' already exists" | tee -a "$KIND_LOG_DIR/service.log"
else
    echo "Creating KIND cluster '$KIND_CLUSTER_NAME'..." | tee -a "$KIND_LOG_DIR/service.log"

    # Build kind create command
    KIND_CMD="kind create cluster --name $KIND_CLUSTER_NAME"

    # Add config file if it exists
    if [ -f "$KIND_CONFIG_FILE" ]; then
        KIND_CMD="$KIND_CMD --config $KIND_CONFIG_FILE"
    fi

    # Add image if specified
    if [ -n "$KIND_IMAGE" ]; then
        KIND_CMD="$KIND_CMD --image $KIND_IMAGE"
    fi

    # Add kubeconfig location
    KIND_CMD="$KIND_CMD --kubeconfig $KIND_KUBECONFIG"

    # Create cluster
    echo "Running: $KIND_CMD" >> "$KIND_LOG_DIR/service.log"
    if eval "$KIND_CMD" 2>&1 | tee -a "$KIND_LOG_DIR/service.log"; then
        echo "✓ Cluster created successfully" | tee -a "$KIND_LOG_DIR/service.log"

        # Set KUBECONFIG for kubectl
        export KUBECONFIG="$KIND_KUBECONFIG"

        # Wait for cluster to be ready
        echo "Waiting for cluster to be ready..." | tee -a "$KIND_LOG_DIR/service.log"
        kubectl wait --for=condition=Ready nodes --all --timeout=300s 2>&1 | tee -a "$KIND_LOG_DIR/service.log"

        echo "✓ Cluster is ready" | tee -a "$KIND_LOG_DIR/service.log"
        echo "" | tee -a "$KIND_LOG_DIR/service.log"
        kubectl cluster-info 2>&1 | tee -a "$KIND_LOG_DIR/service.log"
    else
        echo "✗ Failed to create cluster" | tee -a "$KIND_LOG_DIR/service.log"
        exit 1
    fi
fi

# Keep service running
tail -f /dev/null
'''


## Other Environment Options -----------------------------------------
[options]
# Systems that environment is compatible with
systems = [
  "aarch64-darwin",
  "aarch64-linux",
  "x86_64-darwin",
  "x86_64-linux",
]
