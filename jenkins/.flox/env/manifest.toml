# jenkins-headless - Headless Jenkins Environment
#
# A zero-interaction Jenkins environment configured entirely via environment variables.
# Perfect for automation, CI/CD pipelines, and Docker containers.
#
# Quick Start:
#   flox activate -s                    # Start Jenkins with defaults
#   JENKINS_PORT=9090 flox activate -s  # Override port
#
# Documentation: See README.md

version = 1

## Install Packages -------------------------------------------------------

[install]
jenkins.pkg-path = "jenkins"       # Jenkins 2.528.1
openjdk21.pkg-path = "openjdk21"   # Java 21 runtime
git.pkg-path = "git"               # Version control
curl.pkg-path = "curl"             # HTTP client for downloads
bat.pkg-path = "bat"               # README viewer
jq.pkg-path = "jq"                 # JSON processing

## Environment Variables (Invariant) --------------------------------------
## Use [vars] ONLY for paths that users won't change.
## Runtime-configurable variables go in [hook] section.

[vars]
# Jenkins data directory (persistent across activations)
JENKINS_DATA_DIR = "$FLOX_ENV_CACHE/data/jenkins-home"

# Plugin manager cache
PLUGIN_MGR_DIR = "$FLOX_ENV_CACHE/cache"

## Activation Hook --------------------------------------------------------
## Runs on 'flox activate' to set up the environment.

[hook]
on-activate = '''
# CRITICAL: Use 'return' not 'exit' to keep environment active

# === Directory Structure Setup ===
setup_directories() {
  mkdir -p "$FLOX_ENV_CACHE/config"
  mkdir -p "$FLOX_ENV_CACHE/data/jenkins-home"
  mkdir -p "$FLOX_ENV_CACHE/logs"
  mkdir -p "$FLOX_ENV_CACHE/cache"
}

# === Runtime Configuration (Override with env vars) ===
configure_runtime() {
  export JENKINS_HOME="${JENKINS_HOME:-$FLOX_ENV_CACHE/data/jenkins-home}"
  export JENKINS_PORT="${JENKINS_PORT:-8080}"
  export JENKINS_PREFIX="${JENKINS_PREFIX:-/}"
  export JENKINS_ADMIN_USER="${JENKINS_ADMIN_USER:-admin}"

  # Admin password from env var or config file
  CREDS_FILE="$HOME/.config/jenkins/credentials"
  if [ -z "$JENKINS_ADMIN_PASSWORD" ] && [ -f "$CREDS_FILE" ]; then
    source "$CREDS_FILE"
  fi

  # Java options
  export JENKINS_JAVA_OPTS="${JENKINS_JAVA_OPTS:--Xmx1g -Djava.awt.headless=true}"

  # Plugin selection (space-separated list)
  export JENKINS_PLUGINS="${JENKINS_PLUGINS:-git workflow-aggregator docker-workflow github configuration-as-code}"

  # JCasC configuration file
  export JENKINS_CASC_CONFIG="${JENKINS_CASC_CONFIG:-$FLOX_ENV_CACHE/config/jenkins.yaml}"
}

# === Plugin Installation Manager Setup ===
setup_plugin_manager() {
  PLUGIN_MGR_VERSION="2.13.0"
  PLUGIN_MGR_JAR="$FLOX_ENV_CACHE/cache/jenkins-plugin-manager-${PLUGIN_MGR_VERSION}.jar"
  PLUGIN_MGR_URL="https://github.com/jenkinsci/plugin-installation-manager-tool/releases/download/${PLUGIN_MGR_VERSION}/jenkins-plugin-manager-${PLUGIN_MGR_VERSION}.jar"

  if [ ! -f "$PLUGIN_MGR_JAR" ]; then
    echo "‚¨áÔ∏è  Downloading Jenkins Plugin Installation Manager v${PLUGIN_MGR_VERSION}..."
    if curl -fsSL "$PLUGIN_MGR_URL" -o "$PLUGIN_MGR_JAR"; then
      echo "‚úì Plugin manager downloaded"
    else
      echo "‚ö†Ô∏è  Failed to download plugin manager"
      echo "   Plugins can still be installed manually or via jenkins-cli"
      return 1
    fi
  fi

  # Export for use in functions
  export JENKINS_PLUGIN_MGR_JAR="$PLUGIN_MGR_JAR"
}

# === Find Jenkins WAR File ===
find_jenkins_war() {
  # Find jenkins.war from installed package via jenkins-cli path
  JENKINS_CLI_PATH=$(which jenkins-cli 2>/dev/null)

  if [ -z "$JENKINS_CLI_PATH" ]; then
    echo "‚ùå Could not find jenkins-cli"
    echo "   Make sure jenkins package is installed"
    return 1
  fi

  # Get the package directory and find webapps/jenkins.war
  JENKINS_PKG_DIR=$(dirname "$(dirname "$JENKINS_CLI_PATH")")
  JENKINS_WAR="$JENKINS_PKG_DIR/webapps/jenkins.war"

  if [ ! -f "$JENKINS_WAR" ]; then
    echo "‚ùå Could not find jenkins.war at $JENKINS_WAR"
    echo "   Jenkins package structure may have changed"
    return 1
  fi

  export JENKINS_WAR
}

# === Generate Default JCasC Configuration ===
generate_jcasc_config() {
  JCASC_FILE="$FLOX_ENV_CACHE/config/jenkins.yaml"

  # Only generate if it doesn't exist
  if [ ! -f "$JCASC_FILE" ]; then
    cat > "$JCASC_FILE" << 'EOF'
jenkins:
  systemMessage: "Jenkins Headless Environment (Flox)"
  numExecutors: 0  # Best practice: no builds on controller
  mode: EXCLUSIVE

  securityRealm:
    local:
      allowsSignup: false
      users:
        - id: "${JENKINS_ADMIN_USER}"
          password: "${JENKINS_ADMIN_PASSWORD:-changeme}"

  authorizationStrategy:
    loggedInUsersCanDoAnything:
      allowAnonymousRead: false

unclassified:
  location:
    url: "http://localhost:${JENKINS_PORT}${JENKINS_PREFIX}"
    adminAddress: "jenkins@localhost"
EOF
    echo "‚úì Generated default JCasC configuration: $JCASC_FILE"
  fi
}

# === Main Setup Function ===
main_setup() {
  setup_directories
  configure_runtime
  find_jenkins_war || return 1
  setup_plugin_manager
  generate_jcasc_config

  # Fetch README if missing
  README_FILE="$FLOX_ENV_PROJECT/README.md"
  if [ ! -s "$README_FILE" ]; then
      curl -fsSL "https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/jenkins-headless/README.md" -o "$README_FILE" 2>/dev/null || true
  fi

  # Display configuration
  echo ""
  echo "‚úÖ Jenkins Headless Environment Ready"
  echo ""
  echo "Configuration:"
  echo "  JENKINS_HOME:   $JENKINS_HOME"
  echo "  Port:           $JENKINS_PORT"
  echo "  Prefix:         $JENKINS_PREFIX"
  echo "  Admin User:     $JENKINS_ADMIN_USER"
  echo "  Plugins:        $JENKINS_PLUGINS"
  echo ""
  echo "Commands:"
  echo "  flox activate -s        Start Jenkins service"
  echo "  jenkins-info           Show detailed configuration"
  echo "  jenkins-health         Check Jenkins health"
  echo "  jenkins-logs           Tail Jenkins logs"
  echo "  helpf                  View documentation"
  echo ""
  echo "Runtime Overrides:"
  echo "  JENKINS_PORT=9090 flox activate -s"
  echo "  JENKINS_PLUGINS=\"git pipeline\" flox activate -s"
  echo ""

  # Return to project directory
  cd "$FLOX_ENV_PROJECT"
}

# Execute main setup
main_setup
'''

## Services ---------------------------------------------------------------
## Start Jenkins with: flox activate -s

[services]
jenkins.command = '''
# Ensure JENKINS_HOME exists
mkdir -p "$JENKINS_HOME"
mkdir -p "$FLOX_ENV_CACHE/logs"

# Install plugins if JENKINS_PLUGIN_MGR_JAR is available
if [ -n "$JENKINS_PLUGIN_MGR_JAR" ] && [ -f "$JENKINS_PLUGIN_MGR_JAR" ] && [ -n "$JENKINS_PLUGINS" ]; then
  echo "üì¶ Installing Jenkins plugins..."
  echo "   Plugins: $JENKINS_PLUGINS"

  java -jar "$JENKINS_PLUGIN_MGR_JAR" \
    --war "$JENKINS_WAR" \
    --plugin-download-directory "$JENKINS_HOME/plugins" \
    --plugins $JENKINS_PLUGINS \
    --verbose || echo "‚ö†Ô∏è  Some plugins may have failed to install"

  echo "‚úì Plugin installation complete"
fi

# Start Jenkins
echo "üöÄ Starting Jenkins..."
echo "   URL: http://localhost:${JENKINS_PORT}${JENKINS_PREFIX}"
echo "   JENKINS_HOME: $JENKINS_HOME"
echo ""

exec java $JENKINS_JAVA_OPTS \
  -Djenkins.install.runSetupWizard=false \
  -DJENKINS_HOME="$JENKINS_HOME" \
  -Dcasc.jenkins.config="$JENKINS_CASC_CONFIG" \
  -jar "$JENKINS_WAR" \
  --httpPort="$JENKINS_PORT" \
  --prefix="$JENKINS_PREFIX" \
  2>&1 | tee -a "$FLOX_ENV_CACHE/logs/jenkins.log"
'''

## Profile Functions ------------------------------------------------------
## Available in all shells (bash, zsh, fish)

[profile]
bash = '''
# Show Jenkins configuration
jenkins-info() {
  echo "Jenkins Headless Environment Configuration"
  echo ""
  echo "Version:"
  if [ -f "$JENKINS_WAR" ]; then
    java -jar "$JENKINS_WAR" --version 2>&1 | head -1 || echo "  (Jenkins WAR found)"
  else
    echo "  Jenkins package installed"
  fi
  echo ""
  echo "Server:"
  echo "  URL:            http://localhost:${JENKINS_PORT}${JENKINS_PREFIX}"
  echo "  JENKINS_HOME:   ${JENKINS_HOME}"
  echo "  Admin User:     ${JENKINS_ADMIN_USER}"
  echo ""
  echo "Configuration:"
  echo "  Java Options:   ${JENKINS_JAVA_OPTS}"
  echo "  JCasC Config:   ${JENKINS_CASC_CONFIG}"
  echo "  Plugins:        ${JENKINS_PLUGINS}"
  echo ""
  echo "Logs:"
  echo "  Service Log:    $FLOX_ENV_CACHE/logs/jenkins.log"
  echo "  Jenkins Logs:   $JENKINS_HOME/logs/"
  echo ""
}
export -f jenkins-info

# Check Jenkins health
jenkins-health() {
  local url="http://localhost:${JENKINS_PORT}${JENKINS_PREFIX}/login"

  if curl -sf "$url" >/dev/null 2>&1; then
    echo "‚úÖ Jenkins is healthy"
    echo "   URL: http://localhost:${JENKINS_PORT}${JENKINS_PREFIX}"
    return 0
  else
    echo "‚ùå Jenkins is not responding"
    echo "   URL: $url"
    echo ""
    echo "Troubleshooting:"
    echo "  1. Check if service is running: flox services status"
    echo "  2. View logs: jenkins-logs"
    echo "  3. Check port: netstat -tlnp | grep ${JENKINS_PORT}"
    return 1
  fi
}
export -f jenkins-health

# Tail Jenkins logs
jenkins-logs() {
  local logfile="$FLOX_ENV_CACHE/logs/jenkins.log"

  if [ -f "$logfile" ]; then
    tail -f "$logfile"
  else
    echo "‚ùå Log file not found: $logfile"
    echo "   Start Jenkins first: flox activate -s"
    return 1
  fi
}
export -f jenkins-logs

# Install additional plugin
jenkins-plugin-install() {
  if [ $# -eq 0 ]; then
    echo "Usage: jenkins-plugin-install <plugin-name> [plugin-name...]"
    echo ""
    echo "Examples:"
    echo "  jenkins-plugin-install prometheus"
    echo "  jenkins-plugin-install slack role-strategy"
    return 1
  fi

  if [ ! -f "$JENKINS_PLUGIN_MGR_JAR" ]; then
    echo "‚ùå Plugin manager not available"
    echo "   Download manually or use jenkins-cli"
    return 1
  fi

  echo "üì¶ Installing plugins: $*"

  java -jar "$JENKINS_PLUGIN_MGR_JAR" \
    --war "$JENKINS_WAR" \
    --plugin-download-directory "$JENKINS_HOME/plugins" \
    --plugins "$*" \
    --verbose

  echo ""
  echo "‚úì Plugins installed"
  echo "‚ö†Ô∏è  Restart Jenkins for changes to take effect:"
  echo "   flox services restart jenkins"
}
export -f jenkins-plugin-install

# Open Jenkins in browser
jenkins-url() {
  local url="http://localhost:${JENKINS_PORT}${JENKINS_PREFIX}"
  echo "$url"

  # Try to open in browser (optional)
  if command -v xdg-open >/dev/null 2>&1; then
    xdg-open "$url" 2>/dev/null || true
  elif command -v open >/dev/null 2>&1; then
    open "$url" 2>/dev/null || true
  fi
}
export -f jenkins-url

# View environment documentation
helpf() {
  local README_FILE="$FLOX_ENV_PROJECT/README.md"
  local README_URL="https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/jenkins-headless/README.md"

  if [ "$1" = "--help" ]; then
    echo "Usage: helpf [OPTIONS]"
    echo ""
    echo "View environment documentation"
    echo ""
    echo "Options:"
    echo "  --force    Force download fresh copy from GitHub"
    echo "  --help     Show this help message"
    echo ""
    echo "The README is cached locally and only downloaded if missing."
    return 0
  fi

  if [ "$1" = "--force" ]; then
    echo "Fetching latest README.md from GitHub..."
    if curl -fsSL "$README_URL" -o "$README_FILE"; then
      echo "‚úì Downloaded README.md"
    else
      echo "‚úó Failed to download README.md"
      return 1
    fi
  elif [ ! -f "$README_FILE" ]; then
    echo "README.md not found, downloading..."
    if curl -fsSL "$README_URL" -o "$README_FILE"; then
      echo "‚úì Downloaded README.md"
    else
      echo "‚úó Failed to download README.md"
      return 1
    fi
  fi

  if [ -f "$README_FILE" ]; then
    bat --style=auto --paging=always "$README_FILE"
  else
    echo "‚úó README.md not found at $README_FILE"
    return 1
  fi
}
export -f helpf
'''

zsh = '''
# Show Jenkins configuration
jenkins-info() {
  echo "Jenkins Headless Environment Configuration"
  echo ""
  echo "Version:"
  if [ -f "$JENKINS_WAR" ]; then
    java -jar "$JENKINS_WAR" --version 2>&1 | head -1 || echo "  (Jenkins WAR found)"
  else
    echo "  Jenkins package installed"
  fi
  echo ""
  echo "Server:"
  echo "  URL:            http://localhost:${JENKINS_PORT}${JENKINS_PREFIX}"
  echo "  JENKINS_HOME:   ${JENKINS_HOME}"
  echo "  Admin User:     ${JENKINS_ADMIN_USER}"
  echo ""
  echo "Configuration:"
  echo "  Java Options:   ${JENKINS_JAVA_OPTS}"
  echo "  JCasC Config:   ${JENKINS_CASC_CONFIG}"
  echo "  Plugins:        ${JENKINS_PLUGINS}"
  echo ""
  echo "Logs:"
  echo "  Service Log:    $FLOX_ENV_CACHE/logs/jenkins.log"
  echo "  Jenkins Logs:   $JENKINS_HOME/logs/"
  echo ""
}

# Check Jenkins health
jenkins-health() {
  local url="http://localhost:${JENKINS_PORT}${JENKINS_PREFIX}/login"

  if curl -sf "$url" >/dev/null 2>&1; then
    echo "‚úÖ Jenkins is healthy"
    echo "   URL: http://localhost:${JENKINS_PORT}${JENKINS_PREFIX}"
    return 0
  else
    echo "‚ùå Jenkins is not responding"
    echo "   URL: $url"
    echo ""
    echo "Troubleshooting:"
    echo "  1. Check if service is running: flox services status"
    echo "  2. View logs: jenkins-logs"
    echo "  3. Check port: netstat -tlnp | grep ${JENKINS_PORT}"
    return 1
  fi
}

# Tail Jenkins logs
jenkins-logs() {
  local logfile="$FLOX_ENV_CACHE/logs/jenkins.log"

  if [ -f "$logfile" ]; then
    tail -f "$logfile"
  else
    echo "‚ùå Log file not found: $logfile"
    echo "   Start Jenkins first: flox activate -s"
    return 1
  fi
}

# Install additional plugin
jenkins-plugin-install() {
  if [ $# -eq 0 ]; then
    echo "Usage: jenkins-plugin-install <plugin-name> [plugin-name...]"
    echo ""
    echo "Examples:"
    echo "  jenkins-plugin-install prometheus"
    echo "  jenkins-plugin-install slack role-strategy"
    return 1
  fi

  if [ ! -f "$JENKINS_PLUGIN_MGR_JAR" ]; then
    echo "‚ùå Plugin manager not available"
    echo "   Download manually or use jenkins-cli"
    return 1
  fi

  echo "üì¶ Installing plugins: $*"

  java -jar "$JENKINS_PLUGIN_MGR_JAR" \
    --war "$JENKINS_WAR" \
    --plugin-download-directory "$JENKINS_HOME/plugins" \
    --plugins "$*" \
    --verbose

  echo ""
  echo "‚úì Plugins installed"
  echo "‚ö†Ô∏è  Restart Jenkins for changes to take effect:"
  echo "   flox services restart jenkins"
}

# Open Jenkins in browser
jenkins-url() {
  local url="http://localhost:${JENKINS_PORT}${JENKINS_PREFIX}"
  echo "$url"

  # Try to open in browser (optional)
  if command -v xdg-open >/dev/null 2>&1; then
    xdg-open "$url" 2>/dev/null || true
  elif command -v open >/dev/null 2>&1; then
    open "$url" 2>/dev/null || true
  fi
}

# View environment documentation
helpf() {
  local README_FILE="$FLOX_ENV_PROJECT/README.md"
  local README_URL="https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/jenkins-headless/README.md"

  if [ "$1" = "--help" ]; then
    echo "Usage: helpf [OPTIONS]"
    echo ""
    echo "View environment documentation"
    echo ""
    echo "Options:"
    echo "  --force    Force download fresh copy from GitHub"
    echo "  --help     Show this help message"
    echo ""
    echo "The README is cached locally and only downloaded if missing."
    return 0
  fi

  if [ "$1" = "--force" ]; then
    echo "Fetching latest README.md from GitHub..."
    if curl -fsSL "$README_URL" -o "$README_FILE"; then
      echo "‚úì Downloaded README.md"
    else
      echo "‚úó Failed to download README.md"
      return 1
    fi
  elif [ ! -f "$README_FILE" ]; then
    echo "README.md not found, downloading..."
    if curl -fsSL "$README_URL" -o "$README_FILE"; then
      echo "‚úì Downloaded README.md"
    else
      echo "‚úó Failed to download README.md"
      return 1
    fi
  fi

  if [ -f "$README_FILE" ]; then
    bat --style=auto --paging=always "$README_FILE"
  else
    echo "‚úó README.md not found at $README_FILE"
    return 1
  fi
}
'''

fish = '''
# Show Jenkins configuration
function jenkins-info
  echo "Jenkins Headless Environment Configuration"
  echo ""
  echo "Version:"
  if test -f "$JENKINS_WAR"
    java -jar "$JENKINS_WAR" --version 2>&1 | head -1; or echo "  (Jenkins WAR found)"
  else
    echo "  Jenkins package installed"
  end
  echo ""
  echo "Server:"
  echo "  URL:            http://localhost:$JENKINS_PORT$JENKINS_PREFIX"
  echo "  JENKINS_HOME:   $JENKINS_HOME"
  echo "  Admin User:     $JENKINS_ADMIN_USER"
  echo ""
  echo "Configuration:"
  echo "  Java Options:   $JENKINS_JAVA_OPTS"
  echo "  JCasC Config:   $JENKINS_CASC_CONFIG"
  echo "  Plugins:        $JENKINS_PLUGINS"
  echo ""
  echo "Logs:"
  echo "  Service Log:    $FLOX_ENV_CACHE/logs/jenkins.log"
  echo "  Jenkins Logs:   $JENKINS_HOME/logs/"
  echo ""
end

# Check Jenkins health
function jenkins-health
  set url "http://localhost:$JENKINS_PORT$JENKINS_PREFIX/login"

  if curl -sf "$url" >/dev/null 2>&1
    echo "‚úÖ Jenkins is healthy"
    echo "   URL: http://localhost:$JENKINS_PORT$JENKINS_PREFIX"
    return 0
  else
    echo "‚ùå Jenkins is not responding"
    echo "   URL: $url"
    echo ""
    echo "Troubleshooting:"
    echo "  1. Check if service is running: flox services status"
    echo "  2. View logs: jenkins-logs"
    echo "  3. Check port: netstat -tlnp | grep $JENKINS_PORT"
    return 1
  end
end

# Tail Jenkins logs
function jenkins-logs
  set logfile "$FLOX_ENV_CACHE/logs/jenkins.log"

  if test -f "$logfile"
    tail -f "$logfile"
  else
    echo "‚ùå Log file not found: $logfile"
    echo "   Start Jenkins first: flox activate -s"
    return 1
  end
end

# Install additional plugin
function jenkins-plugin-install
  if test (count $argv) -eq 0
    echo "Usage: jenkins-plugin-install <plugin-name> [plugin-name...]"
    echo ""
    echo "Examples:"
    echo "  jenkins-plugin-install prometheus"
    echo "  jenkins-plugin-install slack role-strategy"
    return 1
  end

  if not test -f "$JENKINS_PLUGIN_MGR_JAR"
    echo "‚ùå Plugin manager not available"
    echo "   Download manually or use jenkins-cli"
    return 1
  end

  echo "üì¶ Installing plugins: $argv"

  java -jar "$JENKINS_PLUGIN_MGR_JAR" \
    --war "$JENKINS_WAR" \
    --plugin-download-directory "$JENKINS_HOME/plugins" \
    --plugins "$argv" \
    --verbose

  echo ""
  echo "‚úì Plugins installed"
  echo "‚ö†Ô∏è  Restart Jenkins for changes to take effect:"
  echo "   flox services restart jenkins"
end

# Open Jenkins in browser
function jenkins-url
  set url "http://localhost:$JENKINS_PORT$JENKINS_PREFIX"
  echo "$url"

  # Try to open in browser (optional)
  if command -v xdg-open >/dev/null 2>&1
    xdg-open "$url" 2>/dev/null; or true
  else if command -v open >/dev/null 2>&1
    open "$url" 2>/dev/null; or true
  end
end

# View environment documentation
function helpf
  set README_FILE "$FLOX_ENV_PROJECT/README.md"
  set README_URL "https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/jenkins-headless/README.md"

  if test "$argv[1]" = "--help"
    echo "Usage: helpf [OPTIONS]"
    echo ""
    echo "View environment documentation"
    echo ""
    echo "Options:"
    echo "  --force    Force download fresh copy from GitHub"
    echo "  --help     Show this help message"
    echo ""
    echo "The README is cached locally and only downloaded if missing."
    return 0
  end

  if test "$argv[1]" = "--force"
    echo "Fetching latest README.md from GitHub..."
    if curl -fsSL "$README_URL" -o "$README_FILE"
      echo "‚úì Downloaded README.md"
    else
      echo "‚úó Failed to download README.md"
      return 1
    end
  else if not test -f "$README_FILE"
    echo "README.md not found, downloading..."
    if curl -fsSL "$README_URL" -o "$README_FILE"
      echo "‚úì Downloaded README.md"
    else
      echo "‚úó Failed to download README.md"
      return 1
    end
  end

  if test -f "$README_FILE"
    bat --style=auto --paging=always "$README_FILE"
  else
    echo "‚úó README.md not found at $README_FILE"
    return 1
  end
end
'''

## Options ----------------------------------------------------------------

[options]
# Cross-platform support
systems = [
  "aarch64-darwin",
  "aarch64-linux",
  "x86_64-darwin",
  "x86_64-linux",
]
