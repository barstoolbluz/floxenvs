## Flox Environment Manifest -----------------------------------------
##
##   _Everything_ you need to know about the _manifest_ is here:
##
##               https://flox.dev/docs/concepts/manifest
##
## -------------------------------------------------------------------
# Flox manifest version managed by Flox CLI
version = 1


## Install Packages --------------------------------------------------
[install]
bat.pkg-path = "bat"
curl.pkg-path = "curl"
neo4j.pkg-path = "neo4j"

## Environment Variables ---------------------------------------------
[vars]
# Base configuration paths
NEO4J_CONFIG_DIR = "$FLOX_ENV_CACHE/neo4j-config"
NEO4J_LOG_DIR = "$FLOX_ENV_CACHE/neo4j-logs"
NEO4J_DATA_DIR = "$FLOX_ENV_CACHE/neo4j-data"

## Activation Hook ---------------------------------------------------
[hook]
on-activate = '''
# Auto-fetch README from FloxHub # Create required directories
mkdir -p "$FLOX_ENV_CACHE/neo4j-config"
mkdir -p "$FLOX_ENV_CACHE/neo4j-logs"
mkdir -p "$FLOX_ENV_CACHE/neo4j-data"
mkdir -p "$FLOX_ENV_CACHE/neo4j-run"

# Runtime-configurable variables with defaults
export NEO4J_HOST="${NEO4J_HOST:-localhost}"
export NEO4J_PORT="${NEO4J_PORT:-7687}"
export NEO4J_HTTP_PORT="${NEO4J_HTTP_PORT:-7474}"
export NEO4J_USER="${NEO4J_USER:-neo4j}"
export NEO4J_PASSWORD="${NEO4J_PASSWORD:-neo4jpass}"
export NEO4J_DIR="${NEO4J_DIR:-$FLOX_ENV_CACHE/neo4j-data}"

# Set derived paths
export NEO4J_DATA="$NEO4J_DIR/data"
export NEO4J_LOGS="$NEO4J_DIR/logs"
export NEO4J_CONF="$NEO4J_DIR/conf"
export NEO4J_RUN="$NEO4J_DIR/run"
export NEO4J_AUTH="${NEO4J_USER}/${NEO4J_PASSWORD}"

# Initialize Neo4j directories
mkdir -p "$NEO4J_DATA" "$NEO4J_LOGS" "$NEO4J_CONF" "$NEO4J_RUN"
chmod 700 "$NEO4J_DATA" "$NEO4J_LOGS" "$NEO4J_CONF" "$NEO4J_RUN"

# Create Neo4j config file
cat > "$NEO4J_CONF/neo4j.conf" << EOF
dbms.default_listen_address=0.0.0.0
dbms.connector.bolt.listen_address=:${NEO4J_PORT}
dbms.connector.http.listen_address=:${NEO4J_HTTP_PORT}
dbms.directories.data=$NEO4J_DATA
dbms.directories.logs=$NEO4J_LOGS
dbms.security.auth_enabled=true
EOF

# Display minimal info
echo ""
echo "✅ Neo4j environment ready (headless mode)"
echo ""
echo "Access URL: http://${NEO4J_HOST}:${NEO4J_HTTP_PORT}"
echo "Bolt URL: bolt://${NEO4J_HOST}:${NEO4J_PORT}"
echo "Username: ${NEO4J_USER}"
echo "Password: ${NEO4J_PASSWORD}"
echo ""
echo "Start service: flox activate -s"
echo "Check status: flox services status"
echo "View logs: flox services logs neo4j"
echo "View docs: helpf"
echo ""

  # Fetch README.md if not present
  README_FILE="$FLOX_ENV_PROJECT/README.md"
  if [ ! -f "$README_FILE" ]; then
    if curl -fsSL https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/neo4j-headless/README.md -o "$README_FILE" 2>/dev/null; then
      echo "✓ Downloaded README.md (use 'helpf' to view)"
    fi
  fi
'''

## Services ----------------------------------------------------------
[services]
neo4j.command = "NEO4J_HOME=$NEO4J_DIR neo4j console"

## Profile script ----------------------------------------------------
[profile]
bash = '''

neo4j-info() {
    echo "Neo4j (Headless Mode)"
    echo ""
    echo "Access URL: http://${NEO4J_HOST}:${NEO4J_HTTP_PORT}"
    echo "Bolt URL: bolt://${NEO4J_HOST}:${NEO4J_PORT}"
    echo "Username: ${NEO4J_USER}"
    echo "Password: ${NEO4J_PASSWORD}"
    echo ""
    echo "Commands:"
    echo "  flox activate -s        Start Neo4j service"
    echo "  flox services status    Check service status"
    echo "  flox services logs neo4j View service logs"
}
export -f neo4j-info

  helpf() {
    local README_FILE="$FLOX_ENV_PROJECT/README.md"
    local README_URL="https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/neo4j-headless/README.md"

    if [ "$1" = "--help" ]; then
      echo "Usage: helpf [OPTIONS]"
      echo ""
      echo "View environment documentation"
      echo ""
      echo "Options:"
      echo "  --force    Force download fresh copy from GitHub"
      echo "  --help     Show this help message"
      echo ""
      echo "The README is cached locally and only downloaded if missing."
      return 0
    fi

    if [ "$1" = "--force" ]; then
      echo "Fetching latest README.md from GitHub..."
      if curl -fsSL "$README_URL" -o "$README_FILE"; then
        echo "✓ Downloaded README.md"
      else
        echo "✗ Failed to download README.md"
        return 1
      fi
    elif [ ! -f "$README_FILE" ]; then
      echo "README.md not found, downloading..."
      if curl -fsSL "$README_URL" -o "$README_FILE"; then
        echo "✓ Downloaded README.md"
      else
        echo "✗ Failed to download README.md"
        return 1
      fi
    fi

    if [ -f "$README_FILE" ]; then
      bat --style=auto --paging=always "$README_FILE"
    else
      echo "✗ README.md not found at $README_FILE"
      return 1
    fi
  }
  export -f helpf
'''

zsh = '''

neo4j-info() {
    echo "Neo4j (Headless Mode)"
    echo ""
    echo "Access URL: http://${NEO4J_HOST}:${NEO4J_HTTP_PORT}"
    echo "Bolt URL: bolt://${NEO4J_HOST}:${NEO4J_PORT}"
    echo "Username: ${NEO4J_USER}"
    echo "Password: ${NEO4J_PASSWORD}"
    echo ""
    echo "Commands:"
    echo "  flox activate -s        Start Neo4j service"
    echo "  flox services status    Check service status"
    echo "  flox services logs neo4j View service logs"
}
export neo4j-info

  helpf() {
    local README_FILE="$FLOX_ENV_PROJECT/README.md"
    local README_URL="https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/neo4j-headless/README.md"

    if [ "$1" = "--help" ]; then
      echo "Usage: helpf [OPTIONS]"
      echo ""
      echo "View environment documentation"
      echo ""
      echo "Options:"
      echo "  --force    Force download fresh copy from GitHub"
      echo "  --help     Show this help message"
      echo ""
      echo "The README is cached locally and only downloaded if missing."
      return 0
    fi

    if [ "$1" = "--force" ]; then
      echo "Fetching latest README.md from GitHub..."
      if curl -fsSL "$README_URL" -o "$README_FILE"; then
        echo "✓ Downloaded README.md"
      else
        echo "✗ Failed to download README.md"
        return 1
      fi
    elif [ ! -f "$README_FILE" ]; then
      echo "README.md not found, downloading..."
      if curl -fsSL "$README_URL" -o "$README_FILE"; then
        echo "✓ Downloaded README.md"
      else
        echo "✗ Failed to download README.md"
        return 1
      fi
    fi

    if [ -f "$README_FILE" ]; then
      bat --style=auto --paging=always "$README_FILE"
    else
      echo "✗ README.md not found at $README_FILE"
      return 1
    fi
  }
'''

fish = '''

function neo4j-info
    echo "Neo4j (Headless Mode)"
    echo ""
    echo "Access URL: http://$NEO4J_HOST:$NEO4J_HTTP_PORT"
    echo "Bolt URL: bolt://$NEO4J_HOST:$NEO4J_PORT"
    echo "Username: $NEO4J_USER"
    echo "Password: $NEO4J_PASSWORD"
    echo ""
    echo "Commands:"
    echo "  flox activate -s        Start Neo4j service"
    echo "  flox services status    Check service status"
    echo "  flox services logs neo4j View service logs"
end

function helpf
    set README_FILE "$FLOX_ENV_PROJECT/README.md"
    set README_URL "https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/neo4j-headless/README.md"

    if test "$argv[1]" = "--help"
        echo "Usage: helpf [OPTIONS]"
        echo ""
        echo "View environment documentation"
        echo ""
        echo "Options:"
        echo "  --force    Force download fresh copy from GitHub"
        echo "  --help     Show this help message"
        echo ""
        echo "The README is cached locally and only downloaded if missing."
        return 0
    end

    if test "$argv[1]" = "--force"
        echo "Fetching latest README.md from GitHub..."
        if curl -fsSL "$README_URL" -o "$README_FILE"
            echo "✓ Downloaded README.md"
        else
            echo "✗ Failed to download README.md"
            return 1
        end
    else if not test -f "$README_FILE"
        echo "README.md not found, downloading..."
        if curl -fsSL "$README_URL" -o "$README_FILE"
            echo "✓ Downloaded README.md"
        else
            echo "✗ Failed to download README.md"
            return 1
        end
    end

    if test -f "$README_FILE"
        bat --style=auto --paging=always "$README_FILE"
    else
        echo "✗ README.md not found at $README_FILE"
        return 1
    end
end
'''

## Other Environment Options -----------------------------------------
[options]
# Systems that environment is compatible with
systems = [
  "aarch64-darwin",
  "aarch64-linux",
  "x86_64-darwin",
  "x86_64-linux",
]
