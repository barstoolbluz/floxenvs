#
# This is a Flox environment manifest.
# Visit flox.dev/docs/concepts/manifest/
# or see flox-edit(1), manifest.toml(5) for more information.
#
# Flox manifest version managed by Flox CLI
version = 1


[install]
# Jupyter Lab
jupyterlab.pkg-path = "python312Packages.jupyterlab"
jupyterlab-lsp.pkg-path = "python312Packages.jupyterlab-lsp"
jupyterlab-server.pkg-path = "python312Packages.jupyterlab-server"
jupyterlab-widgets.pkg-path = "python312Packages.jupyterlab-widgets"
jupyterlab-pygments.pkg-path = "python312Packages.jupyterlab-pygments"
jupyterlab-execute-time.pkg-path = "python312Packages.jupyterlab-execute-time"

# Data science stuffs
pandas.pkg-path = "python312Packages.pandas"
matplotlib.pkg-path = "python312Packages.matplotlib"
numpy.pkg-path = "python312Packages.numpy"
pyarrow.pkg-path = "python312Packages.pyarrow"
sympy.pkg-path = "python312Packages.sympy"
pydot.pkg-path = "python312Packages.pydot"
plotly.pkg-path = "python312Packages.plotly"

[hook]
on-activate = '''
# Runtime-configurable variables with defaults
export JUPYTER_HOST="${JUPYTER_HOST:-0.0.0.0}"
export JUPYTER_PORT="${JUPYTER_PORT:-8888}"
export JUPYTER_SERVER_TOKEN="${JUPYTER_SERVER_TOKEN:-}"
export NOTEBOOK_DIR="${NOTEBOOK_DIR:-$FLOX_ENV_PROJECT}"
export INSTALL_REQUIREMENTS="${INSTALL_REQUIREMENTS:-false}"

# Generate random token if not provided
if [ -z "$JUPYTER_SERVER_TOKEN" ]; then
    export JUPYTER_SERVER_TOKEN="$(openssl rand -hex 32)"
    echo "ℹ️  Generated random token: $JUPYTER_SERVER_TOKEN"
fi

# Setup venv
export VENV_DIR="$FLOX_ENV_CACHE/venv"
if [ ! -d "$VENV_DIR" ]; then
    echo "Creating Python virtual environment..."
    python3.12 -m venv "$VENV_DIR"
fi

# Activate venv with guard
if [ -f "$VENV_DIR/bin/activate" ]; then
    source "$VENV_DIR/bin/activate"

    # Install requirements if requested
    if [ -f "$FLOX_ENV_PROJECT/requirements.txt" ] && [ "$INSTALL_REQUIREMENTS" = "true" ]; then
        echo "Installing packages from requirements.txt..."
        pip install -r "$FLOX_ENV_PROJECT/requirements.txt" --quiet
    fi
fi

# Display minimal info
echo ""
echo "✅ JupyterLab environment ready (headless mode)"
echo ""
echo "Access URL: http://localhost:$JUPYTER_PORT"
echo "Token: ${JUPYTER_SERVER_TOKEN}"
echo ""
echo "Start service: flox activate -s"
echo "Show help: jupyter-help"
echo ""
'''

[services.jupyter-lab]
command = '''
# Activate venv for user packages
if [ -f "$VENV_DIR/bin/activate" ]; then
    source "$VENV_DIR/bin/activate"
fi

exec jupyter-lab \
  --no-browser \
  --ip="$JUPYTER_HOST" \
  --port="$JUPYTER_PORT" \
  --IdentityProvider.token="$JUPYTER_SERVER_TOKEN" \
  --notebook-dir="$NOTEBOOK_DIR"
'''

[profile]
bash = '''
jupyter-help() {
    echo "JupyterLab (Headless Mode)"
    echo ""
    echo "Access URL: http://localhost:$JUPYTER_PORT"
    echo "Token: $JUPYTER_SERVER_TOKEN"
    echo "Notebook Dir: $NOTEBOOK_DIR"
    echo ""
    echo "Commands:"
    echo "  flox activate -s     Start JupyterLab service"
    echo "  flox services status Check service status"
    echo "  pip install <pkg>    Install Python package"
    echo ""
    echo "Runtime Configuration:"
    echo "  JUPYTER_HOST         Default: $JUPYTER_HOST"
    echo "  JUPYTER_PORT         Default: $JUPYTER_PORT"
    echo "  JUPYTER_SERVER_TOKEN Default: (auto-generated)"
    echo "  NOTEBOOK_DIR         Default: $NOTEBOOK_DIR"
    echo "  INSTALL_REQUIREMENTS Default: false"
    echo ""
    echo "Example:"
    echo "  JUPYTER_PORT=9999 JUPYTER_SERVER_TOKEN=mytoken flox activate -s"
}
'''

zsh = '''
jupyter-help() {
    echo "JupyterLab (Headless Mode)"
    echo ""
    echo "Access URL: http://localhost:$JUPYTER_PORT"
    echo "Token: $JUPYTER_SERVER_TOKEN"
    echo "Notebook Dir: $NOTEBOOK_DIR"
    echo ""
    echo "Commands:"
    echo "  flox activate -s     Start JupyterLab service"
    echo "  flox services status Check service status"
    echo "  pip install <pkg>    Install Python package"
    echo ""
    echo "Runtime Configuration:"
    echo "  JUPYTER_HOST         Default: $JUPYTER_HOST"
    echo "  JUPYTER_PORT         Default: $JUPYTER_PORT"
    echo "  JUPYTER_SERVER_TOKEN Default: (auto-generated)"
    echo "  NOTEBOOK_DIR         Default: $NOTEBOOK_DIR"
    echo "  INSTALL_REQUIREMENTS Default: false"
    echo ""
    echo "Example:"
    echo "  JUPYTER_PORT=9999 JUPYTER_SERVER_TOKEN=mytoken flox activate -s"
}
'''

fish = '''
function jupyter-help
    echo "JupyterLab (Headless Mode)"
    echo ""
    echo "Access URL: http://localhost:$JUPYTER_PORT"
    echo "Token: $JUPYTER_SERVER_TOKEN"
    echo "Notebook Dir: $NOTEBOOK_DIR"
    echo ""
    echo "Commands:"
    echo "  flox activate -s     Start JupyterLab service"
    echo "  flox services status Check service status"
    echo "  pip install <pkg>    Install Python package"
    echo ""
    echo "Runtime Configuration:"
    echo "  JUPYTER_HOST         Default: $JUPYTER_HOST"
    echo "  JUPYTER_PORT         Default: $JUPYTER_PORT"
    echo "  JUPYTER_SERVER_TOKEN Default: (auto-generated)"
    echo "  NOTEBOOK_DIR         Default: $NOTEBOOK_DIR"
    echo "  INSTALL_REQUIREMENTS Default: false"
    echo ""
    echo "Example:"
    echo "  JUPYTER_PORT=9999 JUPYTER_SERVER_TOKEN=mytoken flox activate -s"
end
'''

[options]
systems = ["x86_64-linux", "aarch64-darwin", "aarch64-linux", "x86_64-darwin"]
