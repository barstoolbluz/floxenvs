# mysql configuration - Generated on Sun Nov  2 21:13:55 EST 2025
export MYSQL_BIND_ADDRESS="127.0.0.1"
export MYSQL_PORT="13306"
export MYSQL_ROOT_PASSWORD="mysqlpass"
export MYSQL_DATABASE="mysql"
export MYSQLDIR="/home/daedalus/dev/testes/floxenvs/mysql/.flox/cache/mysql"
export MYSQL_DEBUG="false"

## BEGIN ACTIVATION HOOK ##
debug_log () 
{ 
    if [[ "$MYSQL_DEBUG" == "true" ]]; then
        echo "$@";
    fi
}
check_first_run () 
{ 
    if [[ ! -f "$CONFIG_FILE" ]]; then
        return 0;
    else
        return 1;
    fi
}
load_config () 
{ 
    if [[ -f "$CONFIG_FILE" ]]; then
        source "$CONFIG_FILE";
    else
        export MYSQL_BIND_ADDRESS="$DEFAULT_MYSQL_BIND_ADDRESS";
        export MYSQL_PORT="$DEFAULT_MYSQL_PORT";
        export MYSQL_ROOT_PASSWORD="$DEFAULT_MYSQL_ROOT_PASSWORD";
        export MYSQL_DATABASE="$DEFAULT_MYSQL_DATABASE";
        export MYSQLDIR="$DEFAULT_MYSQLDIR";
    fi
}
save_config () 
{ 
    mkdir -p "$(dirname "$CONFIG_FILE")";
    cat > "$CONFIG_FILE" <<EOF
# mysql configuration - Generated on $(date)
export MYSQL_BIND_ADDRESS="$MYSQL_BIND_ADDRESS"
export MYSQL_PORT="$MYSQL_PORT"
export MYSQL_ROOT_PASSWORD="$MYSQL_ROOT_PASSWORD"
export MYSQL_DATABASE="$MYSQL_DATABASE"
export MYSQLDIR="$MYSQLDIR"
export MYSQL_DEBUG="$MYSQL_DEBUG"

## BEGIN ACTIVATION HOOK ##
$(declare -f debug_log)
$(declare -f check_first_run)
$(declare -f load_config)
$(declare -f save_config)
$(declare -f prompt_for_config)
$(declare -f update_dependent_vars)
$(declare -f initialize_mysql)
$(declare -f start_mysql)
$(declare -f set_root_password)
$(declare -f create_database)
$(declare -f stop_mysql)
$(declare -f reconfigure_mysql)
$(declare -f first_run_setup)
$(declare -f display_mysql_config_ui)
$(declare -f mysql_setup)
$(declare -f main)
## END ACTIVATION HOOK ##
EOF

    chmod 644 "$CONFIG_FILE"
}
prompt_for_config () 
{ 
    echo "";
    if gum confirm "$(gum style --foreground 240 'Would you like to customize your MySQL configuration?')" --default=false; then
        MYSQL_BIND_ADDRESS=$(gum input --placeholder "$DEFAULT_MYSQL_BIND_ADDRESS" --value "$DEFAULT_MYSQL_BIND_ADDRESS" --prompt "Bind Address: ");
        MYSQL_PORT=$(gum input --placeholder "$DEFAULT_MYSQL_PORT" --value "$DEFAULT_MYSQL_PORT" --prompt "Port: ");
        MYSQL_ROOT_PASSWORD=$(gum input --placeholder "$DEFAULT_MYSQL_ROOT_PASSWORD" --value "$DEFAULT_MYSQL_ROOT_PASSWORD" --prompt "Root Password: " --password);
        MYSQL_DATABASE=$(gum input --placeholder "$DEFAULT_MYSQL_DATABASE" --value "$DEFAULT_MYSQL_DATABASE" --prompt "Database: ");
        if gum confirm "Use default directory for MySQL data?" --default=true; then
            MYSQLDIR="$DEFAULT_MYSQLDIR";
        else
            MYSQLDIR=$(gum input --placeholder "$DEFAULT_MYSQLDIR" --value "$DEFAULT_MYSQLDIR" --prompt "MySQL Data Directory: ");
        fi;
    else
        MYSQL_BIND_ADDRESS="$DEFAULT_MYSQL_BIND_ADDRESS";
        MYSQL_PORT="$DEFAULT_MYSQL_PORT";
        MYSQL_ROOT_PASSWORD="$DEFAULT_MYSQL_ROOT_PASSWORD";
        MYSQL_DATABASE="$DEFAULT_MYSQL_DATABASE";
        MYSQLDIR="$DEFAULT_MYSQLDIR";
    fi;
    export MYSQL_BIND_ADDRESS MYSQL_PORT MYSQL_ROOT_PASSWORD MYSQL_DATABASE MYSQLDIR;
    save_config
}
update_dependent_vars () 
{ 
    if [[ ! "$MYSQLDIR" = /* ]]; then
        MYSQLDIR="$(pwd)/$MYSQLDIR";
        export MYSQLDIR;
    fi;
    export MYSQL_DATADIR="$MYSQLDIR/data";
    export MYSQL_SOCKET="$MYSQLDIR/run/mysql.sock";
    export MYSQL_SOCKET_DIR="$MYSQLDIR/run";
    export MYSQL_LOG_ERROR="$MYSQLDIR/run/error.log";
    export DATABASE_URL="mysql://root:$MYSQL_ROOT_PASSWORD@$MYSQL_BIND_ADDRESS:$MYSQL_PORT/$MYSQL_DATABASE";
    debug_log "Configuration paths:";
    debug_log "  MYSQLDIR: $MYSQLDIR";
    debug_log "  MYSQL_DATADIR: $MYSQL_DATADIR";
    debug_log "  MYSQL_SOCKET: $MYSQL_SOCKET"
}
initialize_mysql () 
{ 
    mkdir -p "$(dirname "$MYSQL_DATADIR")" && chmod 700 "$(dirname "$MYSQL_DATADIR")";
    rm -rf "$MYSQL_DATADIR" && mkdir -p "$MYSQL_DATADIR" && chmod 700 "$MYSQL_DATADIR";
    mkdir -p "$MYSQL_SOCKET_DIR" && chmod 700 "$MYSQL_SOCKET_DIR";
    if [[ "$MYSQL_DEBUG" == "true" ]]; then
        mysqld --initialize-insecure --datadir="$MYSQL_DATADIR" --user="$USER";
    else
        mysqld --initialize-insecure --datadir="$MYSQL_DATADIR" --user="$USER" > /dev/null 2>&1;
    fi;
    return $?
}
start_mysql () 
{ 
    if [[ ! "$MYSQL_SOCKET_DIR" = /* ]]; then
        debug_log "Warning: MYSQL_SOCKET_DIR is not an absolute path. Using absolute path instead.";
        MYSQL_SOCKET_DIR="$(pwd)/$MYSQL_SOCKET_DIR";
        export MYSQL_SOCKET_DIR;
        export MYSQL_SOCKET="$MYSQL_SOCKET_DIR/mysql.sock";
    fi;
    debug_log "Creating MySQL socket directory at: $MYSQL_SOCKET_DIR";
    mkdir -p "$MYSQL_SOCKET_DIR";
    chmod 700 "$MYSQL_SOCKET_DIR";
    if [[ ! -d "$MYSQL_SOCKET_DIR" ]]; then
        echo "Error: Failed to create MySQL socket directory at $MYSQL_SOCKET_DIR";
        return 1;
    fi;
    debug_log "Starting MySQL with socket: $MYSQL_SOCKET";
    debug_log "Data directory: $MYSQL_DATADIR";
    if [[ "$MYSQL_DEBUG" == "true" ]]; then
        mysqld --datadir="$MYSQL_DATADIR" --socket="$MYSQL_SOCKET" --bind-address="$MYSQL_BIND_ADDRESS" --port="$MYSQL_PORT" --default-authentication-plugin=mysql_native_password --mysqlx=0 --log-error="$MYSQL_LOG_ERROR" & MYSQL_PID=$!;
    else
        mysqld --datadir="$MYSQL_DATADIR" --socket="$MYSQL_SOCKET" --bind-address="$MYSQL_BIND_ADDRESS" --port="$MYSQL_PORT" --default-authentication-plugin=mysql_native_password --mysqlx=0 --log-error="$MYSQL_LOG_ERROR" > /dev/null 2>&1 & MYSQL_PID=$!;
    fi;
    export MYSQL_PID;
    sleep 3;
    return 0
}
set_root_password () 
{ 
    debug_log "Setting root password...";
    mysqladmin -u root --socket="$MYSQL_SOCKET" password "$MYSQL_ROOT_PASSWORD" > /dev/null 2>&1;
    return 0
}
create_database () 
{ 
    if [[ "$MYSQL_DATABASE" != "mysql" ]]; then
        debug_log "Creating database $MYSQL_DATABASE...";
        mysql -u root --password="$MYSQL_ROOT_PASSWORD" --socket="$MYSQL_SOCKET" -e "CREATE DATABASE IF NOT EXISTS \`$MYSQL_DATABASE\`;" > /dev/null 2>&1;
    fi;
    return 0
}
stop_mysql () 
{ 
    if [[ -n "$MYSQL_PID" ]]; then
        debug_log "Stopping MySQL (PID: $MYSQL_PID)...";
        mysqladmin -u root --password="$MYSQL_ROOT_PASSWORD" --socket="$MYSQL_SOCKET" shutdown > /dev/null 2>&1;
        wait $MYSQL_PID 2> /dev/null;
    fi;
    return 0
}
reconfigure_mysql () 
{ 
    rm -f "$CONFIG_FILE";
    first_run_setup;
    mysql_setup
}
first_run_setup () 
{ 
    if check_first_run; then
        display_mysql_config_ui;
    else
        load_config;
    fi;
    update_dependent_vars
}
display_mysql_config_ui () 
{ 
    clear;
    gum style --border rounded --border-foreground 240 --padding "1 2" --margin "1 0" --width 70 "$(gum style --foreground 214 --bold 'MySQL 8.0 Configuration')

$(gum style --foreground 240 'First-time setup for your local development database')";
    prompt_for_config
}
mysql_setup () 
{ 
    debug_log "Setting up MySQL...";
    debug_log "Initializing MySQL...";
    initialize_mysql || { 
        echo "Failed to initialize MySQL";
        return 1
    };
    if [[ -d "$MYSQL_DATADIR/mysql" ]]; then
        debug_log "MySQL data directory initialized successfully";
        debug_log "Starting MySQL...";
        start_mysql || { 
            echo "Failed to start MySQL";
            return 1
        };
        debug_log "Setting root password...";
        set_root_password || { 
            echo "Failed to set root password";
            return 1
        };
        debug_log "Creating database...";
        create_database || { 
            echo "Failed to create database";
            return 1
        };
        debug_log "Stopping MySQL...";
        stop_mysql || { 
            echo "Failed to stop MySQL";
            return 1
        };
        debug_log "MySQL setup completed successfully";
    else
        echo "Error: MySQL data directory was not initialized correctly";
        return 1;
    fi;
    return 0
}
main () 
{ 
    first_run_setup;
    mysql_setup;
    show_mysql_help
}
## END ACTIVATION HOOK ##
