version = 1

[install]
bat.pkg-path = "bat"
curl.pkg-path = "curl"
mysql.pkg-path = "mysql80"

[vars]
# Base configuration paths (invariant)
MYSQL_CONFIG_DIR = "$FLOX_ENV_CACHE/mysql-config"
MYSQL_LOG_DIR = "$FLOX_ENV_CACHE/mysql-logs"
MYSQL_DATA_DIR = "$FLOX_ENV_CACHE/mysql-data"
MYSQL_RUN_DIR = "$FLOX_ENV_CACHE/mysql-run"

[hook]
on-activate = '''
# Auto-fetch README from FloxHub # Create required directories
mkdir -p "$FLOX_ENV_CACHE/mysql-config"
mkdir -p "$FLOX_ENV_CACHE/mysql-logs"
mkdir -p "$FLOX_ENV_CACHE/mysql-data"
mkdir -p "$FLOX_ENV_CACHE/mysql-run"

# === INIT-TIME VARIABLES ===
# These affect mysqld --initialize and cannot change without deleting datadir
export MYSQL_ROOT_PASSWORD="${MYSQL_ROOT_PASSWORD:-mysqlpass}"
export MYSQL_USER="${MYSQL_USER:-}"
export MYSQL_PASSWORD="${MYSQL_PASSWORD:-}"
export MYSQL_CHARSET="${MYSQL_CHARSET:-utf8mb4}"
export MYSQL_COLLATION="${MYSQL_COLLATION:-utf8mb4_unicode_ci}"
export MYSQL_AUTH_PLUGIN="${MYSQL_AUTH_PLUGIN:-mysql_native_password}"
export MYSQL_INIT_ARGS="${MYSQL_INIT_ARGS:-}"

# === RUNTIME VARIABLES - Connection ===
# These can be changed by restarting the service
export MYSQL_BIND_ADDRESS="${MYSQL_BIND_ADDRESS:-127.0.0.1}"
export MYSQL_PORT="${MYSQL_PORT:-13306}"
export MYSQL_DATABASE="${MYSQL_DATABASE:-mysql}"

# === RUNTIME VARIABLES - Performance Basic ===
export MYSQL_MAX_CONNECTIONS="${MYSQL_MAX_CONNECTIONS:-151}"
export MYSQL_INNODB_BUFFER_POOL_SIZE="${MYSQL_INNODB_BUFFER_POOL_SIZE:-128M}"
export MYSQL_TMP_TABLE_SIZE="${MYSQL_TMP_TABLE_SIZE:-16M}"
export MYSQL_MAX_HEAP_TABLE_SIZE="${MYSQL_MAX_HEAP_TABLE_SIZE:-16M}"
export MYSQL_THREAD_CACHE_SIZE="${MYSQL_THREAD_CACHE_SIZE:-9}"

# === RUNTIME VARIABLES - Query Memory ===
export MYSQL_SORT_BUFFER_SIZE="${MYSQL_SORT_BUFFER_SIZE:-256K}"
export MYSQL_JOIN_BUFFER_SIZE="${MYSQL_JOIN_BUFFER_SIZE:-256K}"

# === RUNTIME VARIABLES - InnoDB ===
export MYSQL_INNODB_LOG_FILE_SIZE="${MYSQL_INNODB_LOG_FILE_SIZE:-48M}"
export MYSQL_INNODB_FLUSH_LOG_AT_TRX_COMMIT="${MYSQL_INNODB_FLUSH_LOG_AT_TRX_COMMIT:-1}"
export MYSQL_INNODB_FLUSH_METHOD="${MYSQL_INNODB_FLUSH_METHOD:-}"
export MYSQL_INNODB_FILE_PER_TABLE="${MYSQL_INNODB_FILE_PER_TABLE:-ON}"

# === RUNTIME VARIABLES - Logging ===
export MYSQL_SLOW_QUERY_LOG="${MYSQL_SLOW_QUERY_LOG:-OFF}"
export MYSQL_LONG_QUERY_TIME="${MYSQL_LONG_QUERY_TIME:-10}"
export MYSQL_LOG_BIN="${MYSQL_LOG_BIN:-}"

# === RUNTIME VARIABLES - Binary Log Management ===
export MYSQL_BINLOG_FORMAT="${MYSQL_BINLOG_FORMAT:-MIXED}"
export MYSQL_MAX_BINLOG_SIZE="${MYSQL_MAX_BINLOG_SIZE:-1G}"
export MYSQL_BINLOG_EXPIRE_LOGS_SECONDS="${MYSQL_BINLOG_EXPIRE_LOGS_SECONDS:-2592000}"
export MYSQL_SYNC_BINLOG="${MYSQL_SYNC_BINLOG:-1}"

# === FLEXIBILITY ===
export MYSQL_EXTRA_OPTS="${MYSQL_EXTRA_OPTS:-}"

# === DERIVED VARIABLES ===
export MYSQL_DIR="${MYSQL_DIR:-$FLOX_ENV_CACHE/mysql-data}"
export MYSQL_DATADIR="$MYSQL_DIR/data"
export MYSQL_SOCKET_DIR="$MYSQL_DIR/run"
export MYSQL_SOCKET="$MYSQL_SOCKET_DIR/mysql.sock"
export MYSQL_LOG_ERROR="$MYSQL_SOCKET_DIR/error.log"
export DATABASE_URL="mysql://root:$MYSQL_ROOT_PASSWORD@$MYSQL_BIND_ADDRESS:$MYSQL_PORT/$MYSQL_DATABASE"

# === INITIALIZATION FUNCTION ===
initialize_mysql() {
    # Check if already initialized
    if [ -d "$MYSQL_DATADIR/mysql" ]; then
        return 0
    fi

    # Create directories with proper permissions
    mkdir -p "$MYSQL_DATADIR" "$MYSQL_SOCKET_DIR"
    chmod 700 "$MYSQL_DATADIR" "$MYSQL_SOCKET_DIR"

    # Initialize MySQL with direct execution
    echo "Initializing MySQL database..."
    mysqld --initialize-insecure \
        --datadir="$MYSQL_DATADIR" \
        --user="$USER" \
        $MYSQL_INIT_ARGS \
        > /dev/null 2>&1

    if [ $? -ne 0 ]; then
        echo "❌ Failed to initialize MySQL"
        return 1
    fi

    # Start MySQL temporarily to set password and create database
    echo "Configuring MySQL..."
    mysqld --datadir="$MYSQL_DATADIR" \
        --socket="$MYSQL_SOCKET" \
        --bind-address=127.0.0.1 \
        --port="$MYSQL_PORT" \
        --default-authentication-plugin="$MYSQL_AUTH_PLUGIN" \
        --mysqlx=0 \
        --skip-networking \
        --log-error="$MYSQL_LOG_ERROR" \
        > /dev/null 2>&1 &
    MYSQL_PID=$!

    sleep 3  # Wait for startup

    # Set root password
    mysqladmin -u root --socket="$MYSQL_SOCKET" password "$MYSQL_ROOT_PASSWORD" > /dev/null 2>&1

    # Create additional user if specified
    if [ -n "$MYSQL_USER" ] && [ -n "$MYSQL_PASSWORD" ]; then
        mysql -u root --password="$MYSQL_ROOT_PASSWORD" --socket="$MYSQL_SOCKET" <<EOF > /dev/null 2>&1
CREATE USER IF NOT EXISTS '$MYSQL_USER'@'localhost' IDENTIFIED BY '$MYSQL_PASSWORD';
CREATE USER IF NOT EXISTS '$MYSQL_USER'@'%' IDENTIFIED BY '$MYSQL_PASSWORD';
GRANT ALL PRIVILEGES ON *.* TO '$MYSQL_USER'@'localhost';
GRANT ALL PRIVILEGES ON *.* TO '$MYSQL_USER'@'%';
FLUSH PRIVILEGES;
EOF
    fi

    # Create database if not "mysql"
    if [ "$MYSQL_DATABASE" != "mysql" ]; then
        mysql -u root --password="$MYSQL_ROOT_PASSWORD" --socket="$MYSQL_SOCKET" \
            -e "CREATE DATABASE IF NOT EXISTS \`$MYSQL_DATABASE\`;" > /dev/null 2>&1
    fi

    # Stop MySQL
    mysqladmin -u root --password="$MYSQL_ROOT_PASSWORD" --socket="$MYSQL_SOCKET" shutdown > /dev/null 2>&1
    wait $MYSQL_PID 2>/dev/null

    echo "✅ MySQL initialized successfully"
    return 0
}

# Run initialization
initialize_mysql

# Display info with safety warnings
echo ""
echo "✅ MySQL environment ready (headless mode)"
echo ""

# Safety warnings
if [ "$MYSQL_BIND_ADDRESS" = "0.0.0.0" ]; then
    echo "⚠️  WARNING: Listening on all interfaces - NETWORK EXPOSED"
fi
if [ "$MYSQL_INNODB_FLUSH_LOG_AT_TRX_COMMIT" = "0" ] || [ "$MYSQL_INNODB_FLUSH_LOG_AT_TRX_COMMIT" = "2" ]; then
    echo "⚠️  WARNING: innodb_flush_log_at_trx_commit=$MYSQL_INNODB_FLUSH_LOG_AT_TRX_COMMIT - DATA LOSS RISK"
fi
[ "$MYSQL_BIND_ADDRESS" = "0.0.0.0" ] || [ "$MYSQL_INNODB_FLUSH_LOG_AT_TRX_COMMIT" = "0" ] || [ "$MYSQL_INNODB_FLUSH_LOG_AT_TRX_COMMIT" = "2" ] && echo ""

echo "Connection:"
echo "  Bind address: ${MYSQL_BIND_ADDRESS}:${MYSQL_PORT}"
echo "  Socket: ${MYSQL_SOCKET}"
echo "  Database: ${MYSQL_DATABASE}"
echo "  Root password: ${MYSQL_ROOT_PASSWORD}"
echo ""
echo "Performance:"
echo "  Max connections: ${MYSQL_MAX_CONNECTIONS}"
echo "  InnoDB buffer pool: ${MYSQL_INNODB_BUFFER_POOL_SIZE}"
echo "  InnoDB flush at commit: ${MYSQL_INNODB_FLUSH_LOG_AT_TRX_COMMIT}"
echo ""
echo "Commands:"
echo "  flox activate -s        Start MySQL"
echo "  mysql -u root -p        Connect to database"
echo "  mysql-info              Show configuration"
echo "  helpf                   View documentation"
echo ""

  # Fetch README.md if not present
  README_FILE="$FLOX_ENV_PROJECT/README.md"
  if [ ! -f "$README_FILE" ]; then
    if curl -fsSL https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/mysql-headless/README.md -o "$README_FILE" 2>/dev/null; then
      echo "✓ Downloaded README.md (use 'helpf' to view)"
    fi
  fi
'''

[services]
mysql.command = '''
# Ensure socket directory exists
mkdir -p "$MYSQL_SOCKET_DIR"
chmod 700 "$MYSQL_SOCKET_DIR"

# Start MySQL with all runtime configuration
exec mysqld --datadir="$MYSQL_DATADIR" \
  --socket="$MYSQL_SOCKET" \
  --bind-address="$MYSQL_BIND_ADDRESS" \
  --port="$MYSQL_PORT" \
  --default-authentication-plugin="$MYSQL_AUTH_PLUGIN" \
  --character-set-server="$MYSQL_CHARSET" \
  --collation-server="$MYSQL_COLLATION" \
  --mysqlx=0 \
  --log-error="$MYSQL_LOG_ERROR" \
  --max-connections="$MYSQL_MAX_CONNECTIONS" \
  --innodb-buffer-pool-size="$MYSQL_INNODB_BUFFER_POOL_SIZE" \
  --tmp-table-size="$MYSQL_TMP_TABLE_SIZE" \
  --max-heap-table-size="$MYSQL_MAX_HEAP_TABLE_SIZE" \
  --thread-cache-size="$MYSQL_THREAD_CACHE_SIZE" \
  --sort-buffer-size="$MYSQL_SORT_BUFFER_SIZE" \
  --join-buffer-size="$MYSQL_JOIN_BUFFER_SIZE" \
  --innodb-log-file-size="$MYSQL_INNODB_LOG_FILE_SIZE" \
  --innodb-flush-log-at-trx-commit="$MYSQL_INNODB_FLUSH_LOG_AT_TRX_COMMIT" \
  $([ -n "$MYSQL_INNODB_FLUSH_METHOD" ] && echo "--innodb-flush-method=$MYSQL_INNODB_FLUSH_METHOD") \
  --innodb-file-per-table="$MYSQL_INNODB_FILE_PER_TABLE" \
  --slow-query-log="$MYSQL_SLOW_QUERY_LOG" \
  --long-query-time="$MYSQL_LONG_QUERY_TIME" \
  $([ -n "$MYSQL_LOG_BIN" ] && echo "--log-bin=$MYSQL_LOG_BIN") \
  --binlog-format="$MYSQL_BINLOG_FORMAT" \
  --max-binlog-size="$MYSQL_MAX_BINLOG_SIZE" \
  --binlog-expire-logs-seconds="$MYSQL_BINLOG_EXPIRE_LOGS_SECONDS" \
  --sync-binlog="$MYSQL_SYNC_BINLOG" \
  $MYSQL_EXTRA_OPTS
'''

[profile]
bash = '''

mysql-info() {
    echo "MySQL 8.0 (Headless Mode) - Configuration"
    echo ""
    echo "Connection:"
    echo "  Bind address: ${MYSQL_BIND_ADDRESS}:${MYSQL_PORT}"
    echo "  Socket: ${MYSQL_SOCKET}"
    echo "  Database: ${MYSQL_DATABASE}"
    echo "  Root user: root"
    echo "  Auth plugin: ${MYSQL_AUTH_PLUGIN}"
    echo ""
    echo "Performance:"
    echo "  Max connections: ${MYSQL_MAX_CONNECTIONS}"
    echo "  InnoDB buffer pool: ${MYSQL_INNODB_BUFFER_POOL_SIZE}"
    echo "  Tmp table size: ${MYSQL_TMP_TABLE_SIZE}"
    echo "  Max heap table size: ${MYSQL_MAX_HEAP_TABLE_SIZE}"
    echo "  Thread cache size: ${MYSQL_THREAD_CACHE_SIZE}"
    echo ""
    echo "InnoDB:"
    echo "  Log file size: ${MYSQL_INNODB_LOG_FILE_SIZE}"
    echo "  Flush at commit: ${MYSQL_INNODB_FLUSH_LOG_AT_TRX_COMMIT}"
    echo "  File per table: ${MYSQL_INNODB_FILE_PER_TABLE}"
    echo ""
    echo "Logging:"
    echo "  Slow query log: ${MYSQL_SLOW_QUERY_LOG}"
    echo "  Long query time: ${MYSQL_LONG_QUERY_TIME}s"
    echo ""
    echo "Data Directory: ${MYSQL_DATADIR}"
    echo ""
    echo "Commands:"
    echo "  mysql -u root -p            Connect (password: $MYSQL_ROOT_PASSWORD)"
    echo "  flox services status        Check service status"
    echo "  flox services logs mysql    View service logs"
    echo "  flox services restart mysql Restart with new settings"
}
export -f mysql-info

  helpf() {
    local README_FILE="$FLOX_ENV_PROJECT/README.md"
    local README_URL="https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/mysql-headless/README.md"

    if [ "$1" = "--help" ]; then
      echo "Usage: helpf [OPTIONS]"
      echo ""
      echo "View environment documentation"
      echo ""
      echo "Options:"
      echo "  --force    Force download fresh copy from GitHub"
      echo "  --help     Show this help message"
      echo ""
      echo "The README is cached locally and only downloaded if missing."
      return 0
    fi

    if [ "$1" = "--force" ]; then
      echo "Fetching latest README.md from GitHub..."
      if curl -fsSL "$README_URL" -o "$README_FILE"; then
        echo "✓ Downloaded README.md"
      else
        echo "✗ Failed to download README.md"
        return 1
      fi
    elif [ ! -f "$README_FILE" ]; then
      echo "README.md not found, downloading..."
      if curl -fsSL "$README_URL" -o "$README_FILE"; then
        echo "✓ Downloaded README.md"
      else
        echo "✗ Failed to download README.md"
        return 1
      fi
    fi

    if [ -f "$README_FILE" ]; then
      bat --style=auto --paging=always "$README_FILE"
    else
      echo "✗ README.md not found at $README_FILE"
      return 1
    fi
  }
  export -f helpf
'''

zsh = '''

mysql-info() {
    echo "MySQL 8.0 (Headless Mode) - Configuration"
    echo ""
    echo "Connection:"
    echo "  Bind address: ${MYSQL_BIND_ADDRESS}:${MYSQL_PORT}"
    echo "  Socket: ${MYSQL_SOCKET}"
    echo "  Database: ${MYSQL_DATABASE}"
    echo "  Root user: root"
    echo "  Auth plugin: ${MYSQL_AUTH_PLUGIN}"
    echo ""
    echo "Performance:"
    echo "  Max connections: ${MYSQL_MAX_CONNECTIONS}"
    echo "  InnoDB buffer pool: ${MYSQL_INNODB_BUFFER_POOL_SIZE}"
    echo "  Tmp table size: ${MYSQL_TMP_TABLE_SIZE}"
    echo "  Max heap table size: ${MYSQL_MAX_HEAP_TABLE_SIZE}"
    echo "  Thread cache size: ${MYSQL_THREAD_CACHE_SIZE}"
    echo ""
    echo "InnoDB:"
    echo "  Log file size: ${MYSQL_INNODB_LOG_FILE_SIZE}"
    echo "  Flush at commit: ${MYSQL_INNODB_FLUSH_LOG_AT_TRX_COMMIT}"
    echo "  File per table: ${MYSQL_INNODB_FILE_PER_TABLE}"
    echo ""
    echo "Logging:"
    echo "  Slow query log: ${MYSQL_SLOW_QUERY_LOG}"
    echo "  Long query time: ${MYSQL_LONG_QUERY_TIME}s"
    echo ""
    echo "Data Directory: ${MYSQL_DATADIR}"
    echo ""
    echo "Commands:"
    echo "  mysql -u root -p            Connect (password: $MYSQL_ROOT_PASSWORD)"
    echo "  flox services status        Check service status"
    echo "  flox services logs mysql    View service logs"
    echo "  flox services restart mysql Restart with new settings"
}

  helpf() {
    local README_FILE="$FLOX_ENV_PROJECT/README.md"
    local README_URL="https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/mysql-headless/README.md"

    if [ "$1" = "--help" ]; then
      echo "Usage: helpf [OPTIONS]"
      echo ""
      echo "View environment documentation"
      echo ""
      echo "Options:"
      echo "  --force    Force download fresh copy from GitHub"
      echo "  --help     Show this help message"
      echo ""
      echo "The README is cached locally and only downloaded if missing."
      return 0
    fi

    if [ "$1" = "--force" ]; then
      echo "Fetching latest README.md from GitHub..."
      if curl -fsSL "$README_URL" -o "$README_FILE"; then
        echo "✓ Downloaded README.md"
      else
        echo "✗ Failed to download README.md"
        return 1
      fi
    elif [ ! -f "$README_FILE" ]; then
      echo "README.md not found, downloading..."
      if curl -fsSL "$README_URL" -o "$README_FILE"; then
        echo "✓ Downloaded README.md"
      else
        echo "✗ Failed to download README.md"
        return 1
      fi
    fi

    if [ -f "$README_FILE" ]; then
      bat --style=auto --paging=always "$README_FILE"
    else
      echo "✗ README.md not found at $README_FILE"
      return 1
    fi
  }
'''

fish = '''

function mysql-info
    echo "MySQL 8.0 (Headless Mode) - Configuration"
    echo ""
    echo "Connection:"
    echo "  Bind address: $MYSQL_BIND_ADDRESS:$MYSQL_PORT"
    echo "  Socket: $MYSQL_SOCKET"
    echo "  Database: $MYSQL_DATABASE"
    echo "  Root user: root"
    echo "  Auth plugin: $MYSQL_AUTH_PLUGIN"
    echo ""
    echo "Performance:"
    echo "  Max connections: $MYSQL_MAX_CONNECTIONS"
    echo "  InnoDB buffer pool: $MYSQL_INNODB_BUFFER_POOL_SIZE"
    echo "  Tmp table size: $MYSQL_TMP_TABLE_SIZE"
    echo "  Max heap table size: $MYSQL_MAX_HEAP_TABLE_SIZE"
    echo "  Thread cache size: $MYSQL_THREAD_CACHE_SIZE"
    echo ""
    echo "InnoDB:"
    echo "  Log file size: $MYSQL_INNODB_LOG_FILE_SIZE"
    echo "  Flush at commit: $MYSQL_INNODB_FLUSH_LOG_AT_TRX_COMMIT"
    echo "  File per table: $MYSQL_INNODB_FILE_PER_TABLE"
    echo ""
    echo "Logging:"
    echo "  Slow query log: $MYSQL_SLOW_QUERY_LOG"
    echo "  Long query time: $MYSQL_LONG_QUERY_TIME"s
    echo ""
    echo "Data Directory: $MYSQL_DATADIR"
    echo ""
    echo "Commands:"
    echo "  mysql -u root -p            Connect (password: $MYSQL_ROOT_PASSWORD)"
    echo "  flox services status        Check service status"
    echo "  flox services logs mysql    View service logs"
    echo "  flox services restart mysql Restart with new settings"
end

function helpf
    set README_FILE "$FLOX_ENV_PROJECT/README.md"
    set README_URL "https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/mysql-headless/README.md"

    if test "$argv[1]" = "--help"
        echo "Usage: helpf [OPTIONS]"
        echo ""
        echo "View environment documentation"
        echo ""
        echo "Options:"
        echo "  --force    Force download fresh copy from GitHub"
        echo "  --help     Show this help message"
        echo ""
        echo "The README is cached locally and only downloaded if missing."
        return 0
    end

    if test "$argv[1]" = "--force"
        echo "Fetching latest README.md from GitHub..."
        if curl -fsSL "$README_URL" -o "$README_FILE"
            echo "✓ Downloaded README.md"
        else
            echo "✗ Failed to download README.md"
            return 1
        end
    else if not test -f "$README_FILE"
        echo "README.md not found, downloading..."
        if curl -fsSL "$README_URL" -o "$README_FILE"
            echo "✓ Downloaded README.md"
        else
            echo "✗ Failed to download README.md"
            return 1
        end
    end

    if test -f "$README_FILE"
        bat --style=auto --paging=always "$README_FILE"
    else
        echo "✗ README.md not found at $README_FILE"
        return 1
    end
end
'''

[options]
systems = [
  "aarch64-darwin",
  "aarch64-linux",
  "x86_64-darwin",
  "x86_64-linux",
]
