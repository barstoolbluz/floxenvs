## Flox Environment Manifest -----------------------------------------
##
##   Karapace - Apache Kafka Schema Registry & REST Proxy
##
##   Composable environment providing:
##   - Schema Registry (port 8081)
##   - REST Proxy (port 8082)
##
##   Usage:
##   1. Standalone: flox activate -s
##   2. Composed: Add to kafka environment via [include]
##
## -------------------------------------------------------------------
version = 1

## Install Packages --------------------------------------------------
[install]
curl.pkg-path = "curl"
curl.pkg-group = "tools"

jq.pkg-path = "jq"
jq.pkg-group = "tools"

## Environment Variables ---------------------------------------------
[vars]
# Default Kafka connection (can be overridden at activation)
KARAPACE_BOOTSTRAP_URI = "localhost:9092"

## Activation Hook ---------------------------------------------------
[hook]
on-activate = '''
# Source karapace virtualenv activation script
KARAPACE_RESULT="/home/daedalus/dev/builds/build-karapace/result-karapace"

if [ -f "$KARAPACE_RESULT/bin/activate" ]; then
  source "$KARAPACE_RESULT/bin/activate"
  export PATH="$KARAPACE_RESULT/bin:$PATH"
else
  echo "ERROR: Karapace build not found at $KARAPACE_RESULT"
  echo "Please run: cd /home/daedalus/dev/builds/build-karapace && flox build karapace"
  return 1
fi

# Create log directory
mkdir -p "$FLOX_ENV_CACHE/karapace-logs"

echo "Karapace Schema Registry Environment"
echo "  Bootstrap URI: $KARAPACE_BOOTSTRAP_URI"
echo ""
echo "Start service:"
echo "  flox services start karapace-registry"
echo ""
echo "Override at activation:"
echo "  KARAPACE_BOOTSTRAP_URI=kafka:9092 flox activate -s"
'''

## Services ----------------------------------------------------------
[services.karapace-registry]
command = '''
# Source karapace virtualenv
KARAPACE_RESULT="/home/daedalus/dev/builds/build-karapace/result-karapace"

if [ -f "$KARAPACE_RESULT/bin/activate" ]; then
  source "$KARAPACE_RESULT/bin/activate"
else
  echo "ERROR: Karapace build not found"
  exit 1
fi

# Auto-detect Kafka from composed environment
if [ -n "$KAFKA_HOST" ] && [ -n "$KAFKA_PORT" ]; then
  export KARAPACE_BOOTSTRAP_URI="${KAFKA_HOST}:${KAFKA_PORT}"
elif [ -n "$BOOTSTRAP_SERVERS" ]; then
  export KARAPACE_BOOTSTRAP_URI="$BOOTSTRAP_SERVERS"
fi

# Start Schema Registry
exec karapace
'''
vars.KARAPACE_HOST = "0.0.0.0"
vars.KARAPACE_PORT = "8081"
vars.KARAPACE_TOPIC_NAME = "_schemas"
vars.KARAPACE_LOG_LEVEL = "INFO"
vars.KARAPACE_KARAPACE_REGISTRY = "true"
vars.KARAPACE_KARAPACE_REST = "false"

## Other Environment Options -----------------------------------------
[options]
systems = [
  "x86_64-linux",
]
