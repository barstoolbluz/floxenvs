## Flox Environment Manifest -----------------------------------------
##
##   _Everything_ you need to know about the _manifest_ is here:
##
##               https://flox.dev/docs/concepts/manifest
##
## -------------------------------------------------------------------
# Flox manifest version managed by Flox CLI
version = 1

[install]
ollama-ui.pkg-path = "nextjs-ollama-llm-ui"
ollama.pkg-path = "ollama"
bat.pkg-path = "bat"
curl.pkg-path = "curl"
#firefox.pkg-path = "firefox" # uncomment to install firefox for linux and use this to access the next.js web front-end
#firefox.systems = ["aarch64-linux", "x86_64-linux"] # ibid.

[vars]
NEXT_PUBLIC_OLLAMA_URL="http://localhost:11434"

[hook]
on-activate = '''
  # Fetch README.md if not present
  README_FILE="$FLOX_ENV_PROJECT/README.md"
  if [ ! -f "$README_FILE" ]; then
    if curl -fsSL https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/wsl2-ollama/README.md -o "$README_FILE" 2>/dev/null; then
      echo "‚úì Downloaded README.md (use 'helpf' to view)"
    fi
  fi
'''

[services.ollama]
command="ollama serve"

[services.ollama-ui]
command='''
# wait for ollama to be ready
until ollama list; do sleep 1; done
export NEXT_CACHE_DIR="$FLOX_ENV_CACHE/next"
export PORT=${PORT:-3000}
export HOSTNAME=${HOSTNAME:-127.0.0.1}
mkdir -p $NEXT_CACHE_DIR
nextjs-ollama-llm-ui
'''

[profile]
common = '''
  if ollama list >/dev/null 2>&1; then
    echo "ü§ñ Ollama service running"
    echo "üåê Web interface running on port 3000"
  else
    echo "‚õîÔ∏è Ollama service not available"
  fi
  echo "üìñ Run 'helpf' to view full README documentation"
'''

bash = '''

  helpf() {
    local README_FILE="$FLOX_ENV_PROJECT/README.md"
    local README_URL="https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/wsl2-ollama/README.md"

    if [ "$1" = "--help" ]; then
      echo "Usage: helpf [OPTIONS]"
      echo ""
      echo "View environment documentation"
      echo ""
      echo "Options:"
      echo "  --force    Force download fresh copy from GitHub"
      echo "  --help     Show this help message"
      echo ""
      echo "The README is cached locally and only downloaded if missing."
      return 0
    fi

    if [ "$1" = "--force" ]; then
      echo "Fetching latest README.md from GitHub..."
      if curl -fsSL "$README_URL" -o "$README_FILE"; then
        echo "‚úì Downloaded README.md"
      else
        echo "‚úó Failed to download README.md"
        return 1
      fi
    elif [ ! -f "$README_FILE" ]; then
      echo "README.md not found, downloading..."
      if curl -fsSL "$README_URL" -o "$README_FILE"; then
        echo "‚úì Downloaded README.md"
      else
        echo "‚úó Failed to download README.md"
        return 1
      fi
    fi

    if [ -f "$README_FILE" ]; then
      bat --style=auto --paging=always "$README_FILE"
    else
      echo "‚úó README.md not found at $README_FILE"
      return 1
    fi
  }
  export -f helpf
'''

zsh = '''

  helpf() {
    local README_FILE="$FLOX_ENV_PROJECT/README.md"
    local README_URL="https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/wsl2-ollama/README.md"

    if [ "$1" = "--help" ]; then
      echo "Usage: helpf [OPTIONS]"
      echo ""
      echo "View environment documentation"
      echo ""
      echo "Options:"
      echo "  --force    Force download fresh copy from GitHub"
      echo "  --help     Show this help message"
      echo ""
      echo "The README is cached locally and only downloaded if missing."
      return 0
    fi

    if [ "$1" = "--force" ]; then
      echo "Fetching latest README.md from GitHub..."
      if curl -fsSL "$README_URL" -o "$README_FILE"; then
        echo "‚úì Downloaded README.md"
      else
        echo "‚úó Failed to download README.md"
        return 1
      fi
    elif [ ! -f "$README_FILE" ]; then
      echo "README.md not found, downloading..."
      if curl -fsSL "$README_URL" -o "$README_FILE"; then
        echo "‚úì Downloaded README.md"
      else
        echo "‚úó Failed to download README.md"
        return 1
      fi
    fi

    if [ -f "$README_FILE" ]; then
      bat --style=auto --paging=always "$README_FILE"
    else
      echo "‚úó README.md not found at $README_FILE"
      return 1
    fi
  }
'''

fish = '''

function helpf
    set README_FILE "$FLOX_ENV_PROJECT/README.md"
    set README_URL "https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/wsl2-ollama/README.md"

    if test "$argv[1]" = "--help"
        echo "Usage: helpf [OPTIONS]"
        echo ""
        echo "View environment documentation"
        echo ""
        echo "Options:"
        echo "  --force    Force download fresh copy from GitHub"
        echo "  --help     Show this help message"
        echo ""
        echo "The README is cached locally and only downloaded if missing."
        return 0
    end

    if test "$argv[1]" = "--force"
        echo "Fetching latest README.md from GitHub..."
        if curl -fsSL "$README_URL" -o "$README_FILE"
            echo "‚úì Downloaded README.md"
        else
            echo "‚úó Failed to download README.md"
            return 1
        end
    else if not test -f "$README_FILE"
        echo "README.md not found, downloading..."
        if curl -fsSL "$README_URL" -o "$README_FILE"
            echo "‚úì Downloaded README.md"
        else
            echo "‚úó Failed to download README.md"
            return 1
        end
    end

    if test -f "$README_FILE"
        bat --style=auto --paging=always "$README_FILE"
    else
        echo "‚úó README.md not found at $README_FILE"
        return 1
    end
end
'''

[options]
systems = ["aarch64-darwin", "aarch64-linux", "x86_64-linux", "x86_64-darwin"]
cuda-detection = true
