version = 1

[install]
bat.pkg-path = "bat"
curl.pkg-path = "curl"
mariadb.pkg-path = "mariadb"

[vars]
# Base configuration paths (invariant)
MARIADB_CONFIG_DIR = "$FLOX_ENV_CACHE/mariadb-config"
MARIADB_LOG_DIR = "$FLOX_ENV_CACHE/mariadb-logs"
MARIADB_DATA_DIR = "$FLOX_ENV_CACHE/mariadb-data"
MARIADB_RUN_DIR = "$FLOX_ENV_CACHE/mariadb-run"

[hook]
on-activate = '''
# Create required directories
mkdir -p "$FLOX_ENV_CACHE/mariadb-config"
mkdir -p "$FLOX_ENV_CACHE/mariadb-logs"
mkdir -p "$FLOX_ENV_CACHE/mariadb-data"
mkdir -p "$FLOX_ENV_CACHE/mariadb-run"

# === INIT-TIME VARIABLES ===
# These affect mysql_install_db and cannot change without deleting datadir
export MARIADB_ROOT_PASSWORD="${MARIADB_ROOT_PASSWORD:-mariadbpass}"
export MARIADB_USER="${MARIADB_USER:-}"
export MARIADB_PASSWORD="${MARIADB_PASSWORD:-}"
export MARIADB_CHARSET="${MARIADB_CHARSET:-utf8mb4}"
export MARIADB_COLLATION="${MARIADB_COLLATION:-utf8mb4_unicode_ci}"
export MARIADB_INIT_ARGS="${MARIADB_INIT_ARGS:-}"

# === RUNTIME VARIABLES - Connection ===
# These can be changed by restarting the service
export MARIADB_BIND_ADDRESS="${MARIADB_BIND_ADDRESS:-127.0.0.1}"
export MARIADB_PORT="${MARIADB_PORT:-13307}"
export MARIADB_DATABASE="${MARIADB_DATABASE:-mysql}"

# === RUNTIME VARIABLES - Performance Basic ===
export MARIADB_MAX_CONNECTIONS="${MARIADB_MAX_CONNECTIONS:-151}"
export MARIADB_INNODB_BUFFER_POOL_SIZE="${MARIADB_INNODB_BUFFER_POOL_SIZE:-128M}"
export MARIADB_TMP_TABLE_SIZE="${MARIADB_TMP_TABLE_SIZE:-16M}"
export MARIADB_MAX_HEAP_TABLE_SIZE="${MARIADB_MAX_HEAP_TABLE_SIZE:-16M}"
export MARIADB_THREAD_CACHE_SIZE="${MARIADB_THREAD_CACHE_SIZE:-9}"

# === RUNTIME VARIABLES - Query Memory ===
export MARIADB_SORT_BUFFER_SIZE="${MARIADB_SORT_BUFFER_SIZE:-256K}"
export MARIADB_JOIN_BUFFER_SIZE="${MARIADB_JOIN_BUFFER_SIZE:-256K}"

# === RUNTIME VARIABLES - InnoDB ===
export MARIADB_INNODB_LOG_FILE_SIZE="${MARIADB_INNODB_LOG_FILE_SIZE:-96M}"
export MARIADB_INNODB_FLUSH_LOG_AT_TRX_COMMIT="${MARIADB_INNODB_FLUSH_LOG_AT_TRX_COMMIT:-1}"
export MARIADB_INNODB_FLUSH_METHOD="${MARIADB_INNODB_FLUSH_METHOD:-}"
export MARIADB_INNODB_FILE_PER_TABLE="${MARIADB_INNODB_FILE_PER_TABLE:-ON}"

# === RUNTIME VARIABLES - MariaDB Specific ===
export MARIADB_THREAD_POOL_SIZE="${MARIADB_THREAD_POOL_SIZE:-auto}"

# === RUNTIME VARIABLES - Logging ===
export MARIADB_SLOW_QUERY_LOG="${MARIADB_SLOW_QUERY_LOG:-OFF}"
export MARIADB_LONG_QUERY_TIME="${MARIADB_LONG_QUERY_TIME:-10}"
export MARIADB_LOG_BIN="${MARIADB_LOG_BIN:-}"

# === RUNTIME VARIABLES - Binary Log Management ===
export MARIADB_BINLOG_FORMAT="${MARIADB_BINLOG_FORMAT:-MIXED}"
export MARIADB_MAX_BINLOG_SIZE="${MARIADB_MAX_BINLOG_SIZE:-1G}"
export MARIADB_BINLOG_EXPIRE_LOGS_SECONDS="${MARIADB_BINLOG_EXPIRE_LOGS_SECONDS:-2592000}"
export MARIADB_SYNC_BINLOG="${MARIADB_SYNC_BINLOG:-1}"

# === FLEXIBILITY ===
export MARIADB_EXTRA_OPTS="${MARIADB_EXTRA_OPTS:-}"

# === DERIVED VARIABLES ===
export MARIADB_DIR="${MARIADB_DIR:-$FLOX_ENV_CACHE/mariadb-data}"
export MARIADB_DATADIR="$MARIADB_DIR/data"
export MARIADB_SOCKET_DIR="$MARIADB_DIR/run"
export MARIADB_SOCKET="$MARIADB_SOCKET_DIR/mysql.sock"
export MARIADB_LOG_ERROR="$MARIADB_SOCKET_DIR/error.log"
export DATABASE_URL="mysql://root:$MARIADB_ROOT_PASSWORD@$MARIADB_BIND_ADDRESS:$MARIADB_PORT/$MARIADB_DATABASE"

# === INITIALIZATION FUNCTION ===
initialize_mariadb() {
    # Check if already initialized
    if [ -d "$MARIADB_DATADIR/mysql" ]; then
        return 0
    fi

    # Create directories with proper permissions
    mkdir -p "$MARIADB_DATADIR" "$MARIADB_SOCKET_DIR"
    chmod 700 "$MARIADB_DATADIR" "$MARIADB_SOCKET_DIR"

    # Initialize MariaDB with direct execution
    echo "Initializing MariaDB database..."
    if ! mysql_install_db \
        --datadir="$MARIADB_DATADIR" \
        --user="$USER" \
        $MARIADB_INIT_ARGS \
        > /dev/null 2>&1; then
        echo "❌ Failed to initialize MariaDB"
        echo "Trying without --user flag..."
        mysql_install_db \
            --datadir="$MARIADB_DATADIR" \
            $MARIADB_INIT_ARGS \
            > /dev/null 2>&1 || { echo "❌ Failed again"; return 1; }
    fi

    # Start MariaDB temporarily to set password and create database
    echo "Configuring MariaDB..."
    mysqld --datadir="$MARIADB_DATADIR" \
        --socket="$MARIADB_SOCKET" \
        --bind-address=127.0.0.1 \
        --port="$MARIADB_PORT" \
        --skip-networking \
        --log-error="$MARIADB_LOG_ERROR" \
        > /dev/null 2>&1 &
    MARIADB_PID=$!

    sleep 3  # Wait for startup

    # Set root password (MariaDB uses unix_socket by default, so connect without password first)
    mysql -u root --socket="$MARIADB_SOCKET" <<EOF > /dev/null 2>&1
ALTER USER 'root'@'localhost' IDENTIFIED BY '$MARIADB_ROOT_PASSWORD';
FLUSH PRIVILEGES;
EOF

    # Create additional user if specified
    if [ -n "$MARIADB_USER" ] && [ -n "$MARIADB_PASSWORD" ]; then
        mysql -u root --password="$MARIADB_ROOT_PASSWORD" --socket="$MARIADB_SOCKET" <<EOF > /dev/null 2>&1
CREATE USER IF NOT EXISTS '$MARIADB_USER'@'localhost' IDENTIFIED BY '$MARIADB_PASSWORD';
CREATE USER IF NOT EXISTS '$MARIADB_USER'@'%' IDENTIFIED BY '$MARIADB_PASSWORD';
GRANT ALL PRIVILEGES ON *.* TO '$MARIADB_USER'@'localhost';
GRANT ALL PRIVILEGES ON *.* TO '$MARIADB_USER'@'%';
FLUSH PRIVILEGES;
EOF
    fi

    # Create database if not "mysql"
    if [ "$MARIADB_DATABASE" != "mysql" ]; then
        mysql -u root --password="$MARIADB_ROOT_PASSWORD" --socket="$MARIADB_SOCKET" \
            -e "CREATE DATABASE IF NOT EXISTS \`$MARIADB_DATABASE\`;" > /dev/null 2>&1
    fi

    # Stop MariaDB
    if mysqladmin -u root --password="$MARIADB_ROOT_PASSWORD" --socket="$MARIADB_SOCKET" shutdown > /dev/null 2>&1; then
        wait $MARIADB_PID 2>/dev/null
    else
        # If shutdown fails, try kill
        kill $MARIADB_PID 2>/dev/null
        sleep 1
        kill -9 $MARIADB_PID 2>/dev/null
    fi

    echo "✅ MariaDB initialized successfully"
    return 0
}

# Run initialization
initialize_mariadb

# Display info with safety warnings
echo ""
echo "✅ MariaDB environment ready (headless mode)"
echo ""

# Safety warnings
if [ "$MARIADB_BIND_ADDRESS" = "0.0.0.0" ]; then
    echo "⚠️  WARNING: Listening on all interfaces - NETWORK EXPOSED"
fi
if [ "$MARIADB_INNODB_FLUSH_LOG_AT_TRX_COMMIT" = "0" ] || [ "$MARIADB_INNODB_FLUSH_LOG_AT_TRX_COMMIT" = "2" ]; then
    echo "⚠️  WARNING: innodb_flush_log_at_trx_commit=$MARIADB_INNODB_FLUSH_LOG_AT_TRX_COMMIT - DATA LOSS RISK"
fi
[ "$MARIADB_BIND_ADDRESS" = "0.0.0.0" ] || [ "$MARIADB_INNODB_FLUSH_LOG_AT_TRX_COMMIT" = "0" ] || [ "$MARIADB_INNODB_FLUSH_LOG_AT_TRX_COMMIT" = "2" ] && echo ""

echo "Connection:"
echo "  Bind address: ${MARIADB_BIND_ADDRESS}:${MARIADB_PORT}"
echo "  Socket: ${MARIADB_SOCKET}"
echo "  Database: ${MARIADB_DATABASE}"
echo "  Root password: ${MARIADB_ROOT_PASSWORD}"
echo ""
echo "Performance:"
echo "  Max connections: ${MARIADB_MAX_CONNECTIONS}"
echo "  InnoDB buffer pool: ${MARIADB_INNODB_BUFFER_POOL_SIZE}"
echo "  InnoDB flush at commit: ${MARIADB_INNODB_FLUSH_LOG_AT_TRX_COMMIT}"
echo "  Thread pool size: ${MARIADB_THREAD_POOL_SIZE}"
echo ""
echo "Commands:"
echo "  flox activate -s        Start MariaDB"
echo "  mysql -u root -p        Connect to database"
echo "  mariadb-info            Show configuration"
echo "  helpf                   View environment documentation"
echo ""

# Fetch README if missing

  # Fetch README.md if not present
  README_FILE="$FLOX_ENV_PROJECT/README.md"
  if [ ! -f "$README_FILE" ]; then
    if curl -fsSL https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/mariadb-headless/README.md -o "$README_FILE" 2>/dev/null; then
      echo "✓ Downloaded README.md (use 'helpf' to view)"
    fi
  fi
'''

[services]
mariadb.command = '''
# Ensure socket directory exists
mkdir -p "$MARIADB_SOCKET_DIR"
chmod 700 "$MARIADB_SOCKET_DIR"

# Start MariaDB with all runtime configuration
exec mysqld --datadir="$MARIADB_DATADIR" \
  --socket="$MARIADB_SOCKET" \
  --bind-address="$MARIADB_BIND_ADDRESS" \
  --port="$MARIADB_PORT" \
  --character-set-server="$MARIADB_CHARSET" \
  --collation-server="$MARIADB_COLLATION" \
  --log-error="$MARIADB_LOG_ERROR" \
  --max-connections="$MARIADB_MAX_CONNECTIONS" \
  --innodb-buffer-pool-size="$MARIADB_INNODB_BUFFER_POOL_SIZE" \
  --tmp-table-size="$MARIADB_TMP_TABLE_SIZE" \
  --max-heap-table-size="$MARIADB_MAX_HEAP_TABLE_SIZE" \
  --thread-cache-size="$MARIADB_THREAD_CACHE_SIZE" \
  --sort-buffer-size="$MARIADB_SORT_BUFFER_SIZE" \
  --join-buffer-size="$MARIADB_JOIN_BUFFER_SIZE" \
  --innodb-log-file-size="$MARIADB_INNODB_LOG_FILE_SIZE" \
  --innodb-flush-log-at-trx-commit="$MARIADB_INNODB_FLUSH_LOG_AT_TRX_COMMIT" \
  $([ -n "$MARIADB_INNODB_FLUSH_METHOD" ] && echo "--innodb-flush-method=$MARIADB_INNODB_FLUSH_METHOD") \
  --innodb-file-per-table="$MARIADB_INNODB_FILE_PER_TABLE" \
  --thread-pool-size="$MARIADB_THREAD_POOL_SIZE" \
  --slow-query-log="$MARIADB_SLOW_QUERY_LOG" \
  --long-query-time="$MARIADB_LONG_QUERY_TIME" \
  $([ -n "$MARIADB_LOG_BIN" ] && echo "--log-bin=$MARIADB_LOG_BIN") \
  --binlog-format="$MARIADB_BINLOG_FORMAT" \
  --max-binlog-size="$MARIADB_MAX_BINLOG_SIZE" \
  --binlog-expire-logs-seconds="$MARIADB_BINLOG_EXPIRE_LOGS_SECONDS" \
  --sync-binlog="$MARIADB_SYNC_BINLOG" \
  $MARIADB_EXTRA_OPTS
'''

[profile]
bash = '''
mariadb-info() {
    echo "MariaDB (Headless Mode) - Configuration"
    echo ""
    echo "Connection:"
    echo "  Bind address: ${MARIADB_BIND_ADDRESS}:${MARIADB_PORT}"
    echo "  Socket: ${MARIADB_SOCKET}"
    echo "  Database: ${MARIADB_DATABASE}"
    echo "  Root user: root"
    echo ""
    echo "Performance:"
    echo "  Max connections: ${MARIADB_MAX_CONNECTIONS}"
    echo "  InnoDB buffer pool: ${MARIADB_INNODB_BUFFER_POOL_SIZE}"
    echo "  Tmp table size: ${MARIADB_TMP_TABLE_SIZE}"
    echo "  Max heap table size: ${MARIADB_MAX_HEAP_TABLE_SIZE}"
    echo "  Thread cache size: ${MARIADB_THREAD_CACHE_SIZE}"
    echo "  Thread pool size: ${MARIADB_THREAD_POOL_SIZE}"
    echo ""
    echo "InnoDB:"
    echo "  Log file size: ${MARIADB_INNODB_LOG_FILE_SIZE}"
    echo "  Flush at commit: ${MARIADB_INNODB_FLUSH_LOG_AT_TRX_COMMIT}"
    echo "  File per table: ${MARIADB_INNODB_FILE_PER_TABLE}"
    echo ""
    echo "Logging:"
    echo "  Slow query log: ${MARIADB_SLOW_QUERY_LOG}"
    echo "  Long query time: ${MARIADB_LONG_QUERY_TIME}s"
    echo ""
    echo "Data Directory: ${MARIADB_DATADIR}"
    echo ""
    echo "Commands:"
    echo "  mysql -u root -p              Connect (password: $MARIADB_ROOT_PASSWORD)"
    echo "  flox services status          Check service status"
    echo "  flox services logs mariadb    View service logs"
    echo "  flox services restart mariadb Restart with new settings"
}
export -f mariadb-info

# View environment documentation

  helpf() {
    local README_FILE="$FLOX_ENV_PROJECT/README.md"
    local README_URL="https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/mariadb-headless/README.md"

    if [ "$1" = "--help" ]; then
      echo "Usage: helpf [OPTIONS]"
      echo ""
      echo "View environment documentation"
      echo ""
      echo "Options:"
      echo "  --force    Force download fresh copy from GitHub"
      echo "  --help     Show this help message"
      echo ""
      echo "The README is cached locally and only downloaded if missing."
      return 0
    fi

    if [ "$1" = "--force" ]; then
      echo "Fetching latest README.md from GitHub..."
      if curl -fsSL "$README_URL" -o "$README_FILE"; then
        echo "✓ Downloaded README.md"
      else
        echo "✗ Failed to download README.md"
        return 1
      fi
    elif [ ! -f "$README_FILE" ]; then
      echo "README.md not found, downloading..."
      if curl -fsSL "$README_URL" -o "$README_FILE"; then
        echo "✓ Downloaded README.md"
      else
        echo "✗ Failed to download README.md"
        return 1
      fi
    fi

    if [ -f "$README_FILE" ]; then
      bat --style=auto --paging=always "$README_FILE"
    else
      echo "✗ README.md not found at $README_FILE"
      return 1
    fi
  }
  export -f helpf
'''

zsh = '''
mariadb-info() {
    echo "MariaDB (Headless Mode) - Configuration"
    echo ""
    echo "Connection:"
    echo "  Bind address: ${MARIADB_BIND_ADDRESS}:${MARIADB_PORT}"
    echo "  Socket: ${MARIADB_SOCKET}"
    echo "  Database: ${MARIADB_DATABASE}"
    echo "  Root user: root"
    echo ""
    echo "Performance:"
    echo "  Max connections: ${MARIADB_MAX_CONNECTIONS}"
    echo "  InnoDB buffer pool: ${MARIADB_INNODB_BUFFER_POOL_SIZE}"
    echo "  Tmp table size: ${MARIADB_TMP_TABLE_SIZE}"
    echo "  Max heap table size: ${MARIADB_MAX_HEAP_TABLE_SIZE}"
    echo "  Thread cache size: ${MARIADB_THREAD_CACHE_SIZE}"
    echo "  Thread pool size: ${MARIADB_THREAD_POOL_SIZE}"
    echo ""
    echo "InnoDB:"
    echo "  Log file size: ${MARIADB_INNODB_LOG_FILE_SIZE}"
    echo "  Flush at commit: ${MARIADB_INNODB_FLUSH_LOG_AT_TRX_COMMIT}"
    echo "  File per table: ${MARIADB_INNODB_FILE_PER_TABLE}"
    echo ""
    echo "Logging:"
    echo "  Slow query log: ${MARIADB_SLOW_QUERY_LOG}"
    echo "  Long query time: ${MARIADB_LONG_QUERY_TIME}s"
    echo ""
    echo "Data Directory: ${MARIADB_DATADIR}"
    echo ""
    echo "Commands:"
    echo "  mysql -u root -p              Connect (password: $MARIADB_ROOT_PASSWORD)"
    echo "  flox services status          Check service status"
    echo "  flox services logs mariadb    View service logs"
    echo "  flox services restart mariadb Restart with new settings"
}

# View environment documentation

  helpf() {
    local README_FILE="$FLOX_ENV_PROJECT/README.md"
    local README_URL="https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/mariadb-headless/README.md"

    if [ "$1" = "--help" ]; then
      echo "Usage: helpf [OPTIONS]"
      echo ""
      echo "View environment documentation"
      echo ""
      echo "Options:"
      echo "  --force    Force download fresh copy from GitHub"
      echo "  --help     Show this help message"
      echo ""
      echo "The README is cached locally and only downloaded if missing."
      return 0
    fi

    if [ "$1" = "--force" ]; then
      echo "Fetching latest README.md from GitHub..."
      if curl -fsSL "$README_URL" -o "$README_FILE"; then
        echo "✓ Downloaded README.md"
      else
        echo "✗ Failed to download README.md"
        return 1
      fi
    elif [ ! -f "$README_FILE" ]; then
      echo "README.md not found, downloading..."
      if curl -fsSL "$README_URL" -o "$README_FILE"; then
        echo "✓ Downloaded README.md"
      else
        echo "✗ Failed to download README.md"
        return 1
      fi
    fi

    if [ -f "$README_FILE" ]; then
      bat --style=auto --paging=always "$README_FILE"
    else
      echo "✗ README.md not found at $README_FILE"
      return 1
    fi
  }
'''

fish = '''
function mariadb-info
    echo "MariaDB (Headless Mode) - Configuration"
    echo ""
    echo "Connection:"
    echo "  Bind address: $MARIADB_BIND_ADDRESS:$MARIADB_PORT"
    echo "  Socket: $MARIADB_SOCKET"
    echo "  Database: $MARIADB_DATABASE"
    echo "  Root user: root"
    echo ""
    echo "Performance:"
    echo "  Max connections: $MARIADB_MAX_CONNECTIONS"
    echo "  InnoDB buffer pool: $MARIADB_INNODB_BUFFER_POOL_SIZE"
    echo "  Tmp table size: $MARIADB_TMP_TABLE_SIZE"
    echo "  Max heap table size: $MARIADB_MAX_HEAP_TABLE_SIZE"
    echo "  Thread cache size: $MARIADB_THREAD_CACHE_SIZE"
    echo "  Thread pool size: $MARIADB_THREAD_POOL_SIZE"
    echo ""
    echo "InnoDB:"
    echo "  Log file size: $MARIADB_INNODB_LOG_FILE_SIZE"
    echo "  Flush at commit: $MARIADB_INNODB_FLUSH_LOG_AT_TRX_COMMIT"
    echo "  File per table: $MARIADB_INNODB_FILE_PER_TABLE"
    echo ""
    echo "Logging:"
    echo "  Slow query log: $MARIADB_SLOW_QUERY_LOG"
    echo "  Long query time: $MARIADB_LONG_QUERY_TIME"s
    echo ""
    echo "Data Directory: $MARIADB_DATADIR"
    echo ""
    echo "Commands:"
    echo "  mysql -u root -p              Connect (password: $MARIADB_ROOT_PASSWORD)"
    echo "  flox services status          Check service status"
    echo "  flox services logs mariadb    View service logs"
    echo "  flox services restart mariadb Restart with new settings"
end

# View environment documentationend

  # Fetch README if missing or --force specified
  if test "$force_fetch" = true; or test ! -s "$README_FILE"
    if curl -fsSL "$README_URL" -o "$README_FILE" 2>/dev/null
      test "$force_fetch" = true; and echo "README refreshed from $README_URL"
    else
      echo "Warning: Failed to fetch README from $README_URL"
      test ! -s "$README_FILE"; and return 1
    end
  end

  # Display with bat (if available) or cat
  if command -v bat >/dev/null 2>&1
    bat --paging=always "$README_FILE"
  else
    cat "$README_FILE"
  end
end

function helpf
    set README_FILE "$FLOX_ENV_PROJECT/README.md"
    set README_URL "https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/mariadb-headless/README.md"

    if test "$argv[1]" = "--help"
        echo "Usage: helpf [OPTIONS]"
        echo ""
        echo "View environment documentation"
        echo ""
        echo "Options:"
        echo "  --force    Force download fresh copy from GitHub"
        echo "  --help     Show this help message"
        echo ""
        echo "The README is cached locally and only downloaded if missing."
        return 0
    end

    if test "$argv[1]" = "--force"
        echo "Fetching latest README.md from GitHub..."
        if curl -fsSL "$README_URL" -o "$README_FILE"
            echo "✓ Downloaded README.md"
        else
            echo "✗ Failed to download README.md"
            return 1
        end
    else if not test -f "$README_FILE"
        echo "README.md not found, downloading..."
        if curl -fsSL "$README_URL" -o "$README_FILE"
            echo "✓ Downloaded README.md"
        else
            echo "✗ Failed to download README.md"
            return 1
        end
    end

    if test -f "$README_FILE"
        bat --style=auto --paging=always "$README_FILE"
    else
        echo "✗ README.md not found at $README_FILE"
        return 1
    end
end
'''

[options]
systems = [
  "aarch64-darwin",
  "aarch64-linux",
  "x86_64-darwin",
  "x86_64-linux",
]
