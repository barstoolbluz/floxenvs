version = 1

[install]
nginx.pkg-path = "nginx"
gettext.pkg-path = "gettext"

[vars]
# Invariant paths
NGINX_CONFIG_DIR = "$FLOX_ENV_CACHE/config"
NGINX_LOG_DIR = "$FLOX_ENV_CACHE/logs"
NGINX_WWW_DIR = "$FLOX_ENV_CACHE/www"

[hook]
on-activate = '''
mkdir -p "$FLOX_ENV_CACHE/config"
mkdir -p "$FLOX_ENV_CACHE/logs"
mkdir -p "$FLOX_ENV_CACHE/www"

# === COMMON CONFIGURATION ===
export NGINX_PORT="${NGINX_PORT:-80}"
export NGINX_HOST="${NGINX_HOST:-0.0.0.0}"

# === MODE SELECTION ===
export NGINX_MODE="${NGINX_MODE:-proxy}"
export NGINX_WORKER_PROCESSES="${NGINX_WORKER_PROCESSES:-auto}"
export NGINX_WORKER_CONNECTIONS="${NGINX_WORKER_CONNECTIONS:-1024}"

# === PROXY MODE ===
export NGINX_BACKEND_HOST="${NGINX_BACKEND_HOST:-127.0.0.1}"
export NGINX_BACKEND_PORT="${NGINX_BACKEND_PORT:-8080}"
export NGINX_PROXY_TIMEOUT="${NGINX_PROXY_TIMEOUT:-60s}"

# === STATIC MODE ===
export NGINX_ROOT="${NGINX_ROOT:-$FLOX_ENV_CACHE/www}"
export NGINX_INDEX="${NGINX_INDEX:-index.html index.htm}"

# === LOAD BALANCER MODE ===
export NGINX_UPSTREAM_SERVERS="${NGINX_UPSTREAM_SERVERS:-}"
export NGINX_LB_METHOD="${NGINX_LB_METHOD:-round_robin}"

# === SSL/TLS FEATURE ===
export NGINX_SSL_ENABLED="${NGINX_SSL_ENABLED:-false}"
export NGINX_SSL_CERT="${NGINX_SSL_CERT:-}"
export NGINX_SSL_KEY="${NGINX_SSL_KEY:-}"
export NGINX_SSL_PROTOCOLS="${NGINX_SSL_PROTOCOLS:-TLSv1.2 TLSv1.3}"

# === RATE LIMITING FEATURE ===
export NGINX_RATE_LIMIT_ENABLED="${NGINX_RATE_LIMIT_ENABLED:-false}"
export NGINX_RATE_LIMIT_RATE="${NGINX_RATE_LIMIT_RATE:-10r/s}"
export NGINX_RATE_LIMIT_BURST="${NGINX_RATE_LIMIT_BURST:-20}"

# === GZIP COMPRESSION FEATURE ===
export NGINX_GZIP_ENABLED="${NGINX_GZIP_ENABLED:-false}"
export NGINX_GZIP_LEVEL="${NGINX_GZIP_LEVEL:-6}"
export NGINX_GZIP_MIN_LENGTH="${NGINX_GZIP_MIN_LENGTH:-1000}"
export NGINX_GZIP_TYPES="${NGINX_GZIP_TYPES:-text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript}"

# === SECURITY HEADERS FEATURE ===
export NGINX_SECURITY_HEADERS_ENABLED="${NGINX_SECURITY_HEADERS_ENABLED:-false}"

# === CACHING FEATURE ===
export NGINX_CACHE_ENABLED="${NGINX_CACHE_ENABLED:-false}"
export NGINX_CACHE_STATIC_EXPIRE="${NGINX_CACHE_STATIC_EXPIRE:-7d}"
export NGINX_CACHE_HTML_EXPIRE="${NGINX_CACHE_HTML_EXPIRE:-1h}"

# === WEBSOCKET FEATURE ===
export NGINX_WEBSOCKET_ENABLED="${NGINX_WEBSOCKET_ENABLED:-false}"

# === URL REWRITING FEATURE ===
export NGINX_FORCE_HTTPS="${NGINX_FORCE_HTTPS:-false}"
export NGINX_FORCE_WWW="${NGINX_FORCE_WWW:-none}"

# Create templates (one-time)
create_templates() {
  local CONFIG_DIR="$FLOX_ENV_CACHE/config"

  # Proxy mode template
  if [ ! -f "$CONFIG_DIR/nginx-proxy.template" ]; then
    cat > "$CONFIG_DIR/nginx-proxy.template" << 'TEMPLATE'
worker_processes ${NGINX_WORKER_PROCESSES};
error_log ${NGINX_LOG_DIR}/error.log;
pid ${NGINX_LOG_DIR}/nginx.pid;

events {
    worker_connections ${NGINX_WORKER_CONNECTIONS};
}

http {
    access_log ${NGINX_LOG_DIR}/access.log;

    ${GZIP_CONFIG}

    ${RATE_LIMIT_ZONE}

    server {
        listen ${NGINX_HOST}:${NGINX_PORT}${SSL_LISTEN};

        ${SSL_CONFIG}

        ${SECURITY_HEADERS}

        ${REWRITE_RULES}

        location / {
            ${RATE_LIMIT_REQ}

            proxy_pass http://${NGINX_BACKEND_HOST}:${NGINX_BACKEND_PORT};
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout ${NGINX_PROXY_TIMEOUT};
            proxy_send_timeout ${NGINX_PROXY_TIMEOUT};
            proxy_read_timeout ${NGINX_PROXY_TIMEOUT};
            ${WEBSOCKET_CONFIG}
        }
    }
}
TEMPLATE
  fi

  # Static mode template
  if [ ! -f "$CONFIG_DIR/nginx-static.template" ]; then
    cat > "$CONFIG_DIR/nginx-static.template" << 'TEMPLATE'
worker_processes ${NGINX_WORKER_PROCESSES};
error_log ${NGINX_LOG_DIR}/error.log;
pid ${NGINX_LOG_DIR}/nginx.pid;

events {
    worker_connections ${NGINX_WORKER_CONNECTIONS};
}

http {
    include ${NGINX_MIME_TYPES};
    default_type application/octet-stream;

    access_log ${NGINX_LOG_DIR}/access.log;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;

    ${GZIP_CONFIG}

    ${RATE_LIMIT_ZONE}

    server {
        listen ${NGINX_HOST}:${NGINX_PORT}${SSL_LISTEN};

        ${SSL_CONFIG}

        ${SECURITY_HEADERS}

        ${REWRITE_RULES}

        root ${NGINX_ROOT};
        index ${NGINX_INDEX};

        location / {
            ${RATE_LIMIT_REQ}
            ${CACHE_HTML}
            try_files $uri $uri/ =404;
        }

        ${CACHE_STATIC}
    }
}
TEMPLATE
  fi

  # Load balancer mode template
  if [ ! -f "$CONFIG_DIR/nginx-loadbalancer.template" ]; then
    cat > "$CONFIG_DIR/nginx-loadbalancer.template" << 'TEMPLATE'
worker_processes ${NGINX_WORKER_PROCESSES};
error_log ${NGINX_LOG_DIR}/error.log;
pid ${NGINX_LOG_DIR}/nginx.pid;

events {
    worker_connections ${NGINX_WORKER_CONNECTIONS};
}

http {
    access_log ${NGINX_LOG_DIR}/access.log;

    ${GZIP_CONFIG}

    ${RATE_LIMIT_ZONE}

    ${UPSTREAM_BLOCK}

    server {
        listen ${NGINX_HOST}:${NGINX_PORT}${SSL_LISTEN};

        ${SSL_CONFIG}

        ${SECURITY_HEADERS}

        ${REWRITE_RULES}

        location / {
            ${RATE_LIMIT_REQ}

            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            ${WEBSOCKET_CONFIG}
        }
    }
}
TEMPLATE
  fi

  # Create sample index.html for static mode
  if [ ! -f "$FLOX_ENV_CACHE/www/index.html" ]; then
    cat > "$FLOX_ENV_CACHE/www/index.html" << 'HTML'
<!DOCTYPE html>
<html>
<head>
    <title>nginx-headless</title>
</head>
<body>
    <h1>nginx-headless</h1>
    <p>Static file serving is working!</p>
</body>
</html>
HTML
  fi
}

create_templates

cd "$FLOX_ENV_PROJECT"
'''

[services.nginx]
command = '''
set -e
mkdir -p "$FLOX_ENV_CACHE/logs"

CONFIG_DIR="$FLOX_ENV_CACHE/config"
FINAL_CONF="$CONFIG_DIR/nginx.conf"

# Compute nginx mime.types path
NGINX_BIN=$(which nginx)
NGINX_PREFIX=$(dirname $(dirname "$NGINX_BIN"))
export NGINX_MIME_TYPES="$NGINX_PREFIX/conf/mime.types"

# Generate feature configuration blocks
generate_features() {
  # SSL/TLS Configuration
  if [ "$NGINX_SSL_ENABLED" = "true" ]; then
    if [ -z "$NGINX_SSL_CERT" ] || [ -z "$NGINX_SSL_KEY" ]; then
      echo "Error: NGINX_SSL_ENABLED=true but NGINX_SSL_CERT or NGINX_SSL_KEY not set"
      return 1
    fi
    if [ ! -f "$NGINX_SSL_CERT" ]; then
      echo "Error: SSL certificate not found: $NGINX_SSL_CERT"
      return 1
    fi
    if [ ! -f "$NGINX_SSL_KEY" ]; then
      echo "Error: SSL key not found: $NGINX_SSL_KEY"
      return 1
    fi
    export SSL_LISTEN=" ssl"
    export SSL_CONFIG="ssl_certificate $NGINX_SSL_CERT;
    ssl_certificate_key $NGINX_SSL_KEY;
    ssl_protocols $NGINX_SSL_PROTOCOLS;
    ssl_ciphers HIGH:!aNULL:!MD5;"
  else
    export SSL_LISTEN=""
    export SSL_CONFIG=""
  fi

  # Rate Limiting Configuration
  if [ "$NGINX_RATE_LIMIT_ENABLED" = "true" ]; then
    export RATE_LIMIT_ZONE="limit_req_zone "'$binary_remote_addr'" zone=ratelimit:10m rate=$NGINX_RATE_LIMIT_RATE;"
    export RATE_LIMIT_REQ="limit_req zone=ratelimit burst=$NGINX_RATE_LIMIT_BURST nodelay;"
  else
    export RATE_LIMIT_ZONE=""
    export RATE_LIMIT_REQ=""
  fi

  # Load Balancer Upstream Block
  if [ "$NGINX_MODE" = "load_balancer" ]; then
    if [ -z "$NGINX_UPSTREAM_SERVERS" ]; then
      echo "Error: NGINX_MODE=load_balancer but NGINX_UPSTREAM_SERVERS not set"
      echo "Example: NGINX_UPSTREAM_SERVERS=\"app1:8080,app2:8080,app3:8080\""
      return 1
    fi

    # Determine load balancing directive
    case "$NGINX_LB_METHOD" in
      round_robin)
        LB_DIRECTIVE=""
        ;;
      least_conn)
        LB_DIRECTIVE="least_conn;"
        ;;
      ip_hash)
        LB_DIRECTIVE="ip_hash;"
        ;;
      *)
        echo "Error: Unknown NGINX_LB_METHOD: $NGINX_LB_METHOD"
        echo "Supported: round_robin, least_conn, ip_hash"
        return 1
        ;;
    esac

    # Generate upstream block
    UPSTREAM="upstream backend {"$'\n'"    $LB_DIRECTIVE"$'\n'
    IFS=',' read -ra SERVERS <<< "$NGINX_UPSTREAM_SERVERS"
    for server in "${SERVERS[@]}"; do
      server=$(echo "$server" | xargs)  # Trim whitespace
      UPSTREAM+="    server $server;"$'\n'
    done
    UPSTREAM+="}"
    export UPSTREAM_BLOCK="$UPSTREAM"
  else
    export UPSTREAM_BLOCK=""
  fi

  # Gzip Compression Configuration
  if [ "$NGINX_GZIP_ENABLED" = "true" ]; then
    export GZIP_CONFIG="gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level $NGINX_GZIP_LEVEL;
    gzip_min_length $NGINX_GZIP_MIN_LENGTH;
    gzip_types $NGINX_GZIP_TYPES;"
  else
    export GZIP_CONFIG=""
  fi

  # Security Headers Configuration
  if [ "$NGINX_SECURITY_HEADERS_ENABLED" = "true" ]; then
    HEADERS="add_header X-Frame-Options SAMEORIGIN always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-XSS-Protection \"1; mode=block\" always;
    add_header Referrer-Policy no-referrer-when-downgrade always;"

    # Add HSTS if SSL is enabled
    if [ "$NGINX_SSL_ENABLED" = "true" ]; then
      HEADERS+=$'\n'"    add_header Strict-Transport-Security \"max-age=31536000; includeSubDomains\" always;"
    fi

    export SECURITY_HEADERS="$HEADERS"
  else
    export SECURITY_HEADERS=""
  fi

  # Caching Configuration (for static mode)
  if [ "$NGINX_CACHE_ENABLED" = "true" ]; then
    export CACHE_HTML="add_header Cache-Control \"public, max-age=3600\";
            expires $NGINX_CACHE_HTML_EXPIRE;"

    export CACHE_STATIC="location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
            expires $NGINX_CACHE_STATIC_EXPIRE;
            add_header Cache-Control \"public, immutable\";
        }"
  else
    export CACHE_HTML=""
    export CACHE_STATIC=""
  fi

  # WebSocket Configuration (for proxy and load_balancer modes)
  if [ "$NGINX_WEBSOCKET_ENABLED" = "true" ]; then
    export WEBSOCKET_CONFIG="proxy_http_version 1.1;
            proxy_set_header Upgrade \$http_upgrade;
            proxy_set_header Connection \"upgrade\";"
  else
    export WEBSOCKET_CONFIG=""
  fi

  # URL Rewriting Configuration
  REWRITE=""

  # Force HTTPS redirect
  if [ "$NGINX_FORCE_HTTPS" = "true" ]; then
    REWRITE+="if (\$scheme != \"https\") {"$'\n'
    REWRITE+="            return 301 https://\$host\$request_uri;"$'\n'
    REWRITE+="        }"$'\n'
  fi

  # Force WWW or non-WWW
  if [ "$NGINX_FORCE_WWW" = "add_www" ]; then
    REWRITE+="if (\$host !~* ^www\\.) {"$'\n'
    REWRITE+="            return 301 \$scheme://www.\$host\$request_uri;"$'\n'
    REWRITE+="        }"$'\n'
  elif [ "$NGINX_FORCE_WWW" = "remove_www" ]; then
    REWRITE+="if (\$host ~* ^www\\.(.*)) {"$'\n'
    REWRITE+="            return 301 \$scheme://\$1\$request_uri;"$'\n'
    REWRITE+="        }"$'\n'
  fi

  export REWRITE_RULES="$REWRITE"
}

# Select mode template
case "$NGINX_MODE" in
  proxy)
    TEMPLATE="$CONFIG_DIR/nginx-proxy.template"
    ;;
  static)
    TEMPLATE="$CONFIG_DIR/nginx-static.template"
    ;;
  load_balancer)
    TEMPLATE="$CONFIG_DIR/nginx-loadbalancer.template"
    ;;
  *)
    echo "Error: Unknown NGINX_MODE: $NGINX_MODE"
    echo "Supported modes: proxy, static, load_balancer"
    exit 1
    ;;
esac

if [ ! -f "$TEMPLATE" ]; then
  echo "Error: Template not found: $TEMPLATE"
  exit 1
fi

# Generate feature configurations
generate_features || exit 1

# Apply envsubst with explicit variable list (preserves nginx variables)
envsubst '${NGINX_WORKER_PROCESSES} ${NGINX_LOG_DIR} ${NGINX_WORKER_CONNECTIONS} ${NGINX_MIME_TYPES} ${GZIP_CONFIG} ${RATE_LIMIT_ZONE} ${NGINX_HOST} ${NGINX_PORT} ${SSL_LISTEN} ${SSL_CONFIG} ${SECURITY_HEADERS} ${RATE_LIMIT_REQ} ${NGINX_BACKEND_HOST} ${NGINX_BACKEND_PORT} ${NGINX_PROXY_TIMEOUT} ${NGINX_ROOT} ${NGINX_INDEX} ${UPSTREAM_BLOCK} ${CACHE_HTML} ${CACHE_STATIC} ${WEBSOCKET_CONFIG} ${REWRITE_RULES}' < "$TEMPLATE" > "$FINAL_CONF"

# Validate configuration
if ! nginx -t -c "$FINAL_CONF"; then
  echo "Error: nginx configuration validation failed"
  echo "Configuration file: $FINAL_CONF"
  exit 1
fi

# Start nginx
exec nginx -c "$FINAL_CONF" -g "daemon off;" 2>&1 | tee -a "$FLOX_ENV_CACHE/logs/nginx.log"
'''

[options]
systems = [
  "aarch64-darwin",
  "aarch64-linux",
  "x86_64-darwin",
  "x86_64-linux",
]
