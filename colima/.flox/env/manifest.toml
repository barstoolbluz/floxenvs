version = 1

[install]
colima.pkg-path = "colima"
docker.pkg-path = "docker-client"
kubectl.pkg-path = "kubectl"

# For helpf documentation viewer
bat.pkg-path = "bat"
curl.pkg-path = "curl"

[hook]
on-activate = '''
# ============================================================================
# COLIMA CONFIGURATION
# ============================================================================
# Runtime-configurable variables with defaults
# Override: COLIMA_CPU=4 COLIMA_MEMORY=8 flox activate
# ============================================================================

export COLIMA_CPU="${COLIMA_CPU:-2}"
export COLIMA_MEMORY="${COLIMA_MEMORY:-2}"
export COLIMA_DISK="${COLIMA_DISK:-60}"
export COLIMA_ARCH="${COLIMA_ARCH:-x86_64}"
export COLIMA_RUNTIME="${COLIMA_RUNTIME:-docker}"
export COLIMA_PROFILE="${COLIMA_PROFILE:-default}"
export COLIMA_KUBERNETES="${COLIMA_KUBERNETES:-false}"

# Auto-detect CPU type based on KVM availability (Linux)
if [ -z "$COLIMA_CPU_TYPE" ]; then
  if [ "$(uname)" = "Linux" ] && [ -w /dev/kvm ]; then
    export COLIMA_CPU_TYPE="host"
  else
    export COLIMA_CPU_TYPE="qemu64"
  fi
else
  export COLIMA_CPU_TYPE="${COLIMA_CPU_TYPE}"
fi

# ============================================================================
# SETUP COLIMA CONFIGURATION
# ============================================================================

setup_colima() {
  local config_dir="$HOME/.colima/$COLIMA_PROFILE"
  local config_file="$config_dir/colima.yaml"

  mkdir -p "$config_dir"

  # Generate config if it doesn't exist
  if [ ! -f "$config_file" ]; then
    cat > "$config_file" << EOFCFG
cpu: ${COLIMA_CPU}
memory: ${COLIMA_MEMORY}
disk: ${COLIMA_DISK}
arch: ${COLIMA_ARCH}
runtime: ${COLIMA_RUNTIME}
cpuType: "${COLIMA_CPU_TYPE}"
EOFCFG
    echo "âœ… Created Colima config: $config_file"
  fi
}

setup_colima

# ============================================================================
# DISPLAY CONFIGURATION
# ============================================================================

echo ""
echo "ðŸ³ Colima Container Runtime Environment"
echo ""
echo "Active Configuration:"
echo "  Profile:     $COLIMA_PROFILE"
echo "  CPU:         $COLIMA_CPU cores ($COLIMA_CPU_TYPE)"
echo "  Memory:      ${COLIMA_MEMORY}GB"
echo "  Disk:        ${COLIMA_DISK}GB"
echo "  Runtime:     $COLIMA_RUNTIME"
echo "  Kubernetes:  $COLIMA_KUBERNETES"
echo ""
echo "Runtime Override Examples:"
echo "  COLIMA_CPU=4 COLIMA_MEMORY=8 flox activate"
echo "  COLIMA_RUNTIME=containerd flox activate"
echo "  COLIMA_PROFILE=dev flox activate"
echo "  COLIMA_KUBERNETES=true flox activate"
echo ""
echo "Commands:"
echo "  flox activate -s      Start Colima service"
echo "  colima-info           Show configuration"
echo "  docker ps             Test Docker connection"
echo "  helpf                 View environment documentation"
echo ""

fi

  # Fetch README.md if not present
  README_FILE="$FLOX_ENV_PROJECT/README.md"
  if [ ! -f "$README_FILE" ]; then
    if curl -fsSL https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/colima-headless/README.md -o "$README_FILE" 2>/dev/null; then
      echo "âœ“ Downloaded README.md (use 'helpf' to view)"
    fi
  fi
'''

[profile]
common = '''
export DOCKER_HOST="unix://$HOME/.colima/$COLIMA_PROFILE/docker.sock"
export KUBECONFIG="$HOME/.colima/$COLIMA_PROFILE/kubeconfig"
'''

bash = '''
colima-info() {
  echo "Colima Container Runtime"
  echo ""
  echo "Configuration:"
  echo "  Profile:     $COLIMA_PROFILE"
  echo "  CPU:         $COLIMA_CPU cores ($COLIMA_CPU_TYPE)"
  echo "  Memory:      ${COLIMA_MEMORY}GB"
  echo "  Disk:        ${COLIMA_DISK}GB"
  echo "  Runtime:     $COLIMA_RUNTIME"
  echo "  Kubernetes:  $COLIMA_KUBERNETES"
  echo ""
  echo "Docker Socket: $DOCKER_HOST"
  echo ""
  echo "Service Commands:"
  echo "  flox activate -s            Start Colima"
  echo "  flox services status        Check status"
  echo "  flox services logs colima   View logs"
  echo "  colima status               Check Colima status"
  echo ""
  echo "Runtime Variables (override on activate):"
  echo "  COLIMA_CPU         CPU cores (default: 2)"
  echo "  COLIMA_MEMORY      Memory in GB (default: 2)"
  echo "  COLIMA_DISK        Disk in GB (default: 60)"
  echo "  COLIMA_RUNTIME     docker|containerd|incus (default: docker)"
  echo "  COLIMA_PROFILE     Profile name (default: default)"
  echo "  COLIMA_CPU_TYPE    CPU type (default: auto-detected)"
  echo "  COLIMA_KUBERNETES  Enable Kubernetes (default: false)"
  echo ""
  echo "Documentation:"
  echo "  helpf              View environment documentation"
}
export -f colima-info

  helpf() {
    local README_FILE="$FLOX_ENV_PROJECT/README.md"
    local README_URL="https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/colima-headless/README.md"

    if [ "$1" = "--help" ]; then
      echo "Usage: helpf [OPTIONS]"
      echo ""
      echo "View environment documentation"
      echo ""
      echo "Options:"
      echo "  --force    Force download fresh copy from GitHub"
      echo "  --help     Show this help message"
      echo ""
      echo "The README is cached locally and only downloaded if missing."
      return 0
    fi

    if [ "$1" = "--force" ]; then
      echo "Fetching latest README.md from GitHub..."
      if curl -fsSL "$README_URL" -o "$README_FILE"; then
        echo "âœ“ Downloaded README.md"
      else
        echo "âœ— Failed to download README.md"
        return 1
      fi
    elif [ ! -f "$README_FILE" ]; then
      echo "README.md not found, downloading..."
      if curl -fsSL "$README_URL" -o "$README_FILE"; then
        echo "âœ“ Downloaded README.md"
      else
        echo "âœ— Failed to download README.md"
        return 1
      fi
    fi

    if [ -f "$README_FILE" ]; then
      bat --style=auto --paging=always "$README_FILE"
    else
      echo "âœ— README.md not found at $README_FILE"
      return 1
    fi
  }
  export -f helpf
'''

zsh = '''
colima-info() {
  echo "Colima Container Runtime"
  echo ""
  echo "Configuration:"
  echo "  Profile:     $COLIMA_PROFILE"
  echo "  CPU:         $COLIMA_CPU cores ($COLIMA_CPU_TYPE)"
  echo "  Memory:      ${COLIMA_MEMORY}GB"
  echo "  Disk:        ${COLIMA_DISK}GB"
  echo "  Runtime:     $COLIMA_RUNTIME"
  echo "  Kubernetes:  $COLIMA_KUBERNETES"
  echo ""
  echo "Docker Socket: $DOCKER_HOST"
  echo ""
  echo "Service Commands:"
  echo "  flox activate -s            Start Colima"
  echo "  flox services status        Check status"
  echo "  flox services logs colima   View logs"
  echo "  colima status               Check Colima status"
  echo ""
  echo "Runtime Variables (override on activate):"
  echo "  COLIMA_CPU         CPU cores (default: 2)"
  echo "  COLIMA_MEMORY      Memory in GB (default: 2)"
  echo "  COLIMA_DISK        Disk in GB (default: 60)"
  echo "  COLIMA_RUNTIME     docker|containerd|incus (default: docker)"
  echo "  COLIMA_PROFILE     Profile name (default: default)"
  echo "  COLIMA_CPU_TYPE    CPU type (default: auto-detected)"
  echo "  COLIMA_KUBERNETES  Enable Kubernetes (default: false)"
  echo ""
  echo "Documentation:"
  echo "  helpf              View environment documentation"
}

  helpf() {
    local README_FILE="$FLOX_ENV_PROJECT/README.md"
    local README_URL="https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/colima-headless/README.md"

    if [ "$1" = "--help" ]; then
      echo "Usage: helpf [OPTIONS]"
      echo ""
      echo "View environment documentation"
      echo ""
      echo "Options:"
      echo "  --force    Force download fresh copy from GitHub"
      echo "  --help     Show this help message"
      echo ""
      echo "The README is cached locally and only downloaded if missing."
      return 0
    fi

    if [ "$1" = "--force" ]; then
      echo "Fetching latest README.md from GitHub..."
      if curl -fsSL "$README_URL" -o "$README_FILE"; then
        echo "âœ“ Downloaded README.md"
      else
        echo "âœ— Failed to download README.md"
        return 1
      fi
    elif [ ! -f "$README_FILE" ]; then
      echo "README.md not found, downloading..."
      if curl -fsSL "$README_URL" -o "$README_FILE"; then
        echo "âœ“ Downloaded README.md"
      else
        echo "âœ— Failed to download README.md"
        return 1
      fi
    fi

    if [ -f "$README_FILE" ]; then
      bat --style=auto --paging=always "$README_FILE"
    else
      echo "âœ— README.md not found at $README_FILE"
      return 1
    fi
  }
'''

fish = '''
function colima-info
  echo "Colima Container Runtime"
  echo ""
  echo "Configuration:"
  echo "  Profile:     $COLIMA_PROFILE"
  echo "  CPU:         $COLIMA_CPU cores ($COLIMA_CPU_TYPE)"
  echo "  Memory:      $COLIMA_MEMORY"GB
  echo "  Disk:        ${COLIMA_DISK}GB"
  echo "  Runtime:     $COLIMA_RUNTIME"
  echo "  Kubernetes:  $COLIMA_KUBERNETES"
  echo ""
  echo "Docker Socket: $DOCKER_HOST"
  echo ""
  echo "Service Commands:"
  echo "  flox activate -s            Start Colima"
  echo "  flox services status        Check status"
  echo "  flox services logs colima   View logs"
  echo "  colima status               Check Colima status"
  echo ""
  echo "Runtime Variables (override on activate):"
  echo "  COLIMA_CPU         CPU cores (default: 2)"
  echo "  COLIMA_MEMORY      Memory in GB (default: 2)"
  echo "  COLIMA_DISK        Disk in GB (default: 60)"
  echo "  COLIMA_RUNTIME     docker|containerd|incus (default: docker)"
  echo "  COLIMA_PROFILE     Profile name (default: default)"
  echo "  COLIMA_CPU_TYPE    CPU type (default: auto-detected)"
  echo "  COLIMA_KUBERNETES  Enable Kubernetes (default: false)"
  echo ""
  echo "Documentation:"
  echo "  helpf              View environment documentation"
endif test "$argv[1]" = "--force"
        echo "Fetching latest README.md from GitHub..."
        if curl -fsSL "$README_URL" -o "$README_FILE"
            echo "âœ“ Downloaded README.md"
        else
            echo "âœ— Failed to download README.md"
            return 1
        end
    else if not test -f "$README_FILE"
        echo "README.md not found, downloading..."
        if curl -fsSL "$README_URL" -o "$README_FILE"
            echo "âœ“ Downloaded README.md"
        else
            echo "âœ— Failed to download README.md"
            return 1
        end
    end

    if test -f "$README_FILE"
        bat --style=auto --paging=always "$README_FILE"
    else
        echo "âœ— README.md not found at $README_FILE"
        return 1
    end
end

function helpf
    set README_FILE "$FLOX_ENV_PROJECT/README.md"
    set README_URL "https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/colima-headless/README.md"

    if test "$argv[1]" = "--help"
        echo "Usage: helpf [OPTIONS]"
        echo ""
        echo "View environment documentation"
        echo ""
        echo "Options:"
        echo "  --force    Force download fresh copy from GitHub"
        echo "  --help     Show this help message"
        echo ""
        echo "The README is cached locally and only downloaded if missing."
        return 0
    end

    if test "$argv[1]" = "--force"
        echo "Fetching latest README.md from GitHub..."
        if curl -fsSL "$README_URL" -o "$README_FILE"
            echo "âœ“ Downloaded README.md"
        else
            echo "âœ— Failed to download README.md"
            return 1
        end
    else if not test -f "$README_FILE"
        echo "README.md not found, downloading..."
        if curl -fsSL "$README_URL" -o "$README_FILE"
            echo "âœ“ Downloaded README.md"
        else
            echo "âœ— Failed to download README.md"
            return 1
        end
    end

    if test -f "$README_FILE"
        bat --style=auto --paging=always "$README_FILE"
    else
        echo "âœ— README.md not found at $README_FILE"
        return 1
    end
end
'''

[services]
colima.command = '''
echo "Starting Colima profile: $COLIMA_PROFILE"
echo "Configuration: ${COLIMA_CPU}CPU, ${COLIMA_MEMORY}GB RAM, ${COLIMA_DISK}GB disk"

# Start Colima with configuration from environment variables
# --foreground keeps it running in the foreground
COLIMA_CMD="colima start"
COLIMA_CMD="$COLIMA_CMD --cpu $COLIMA_CPU"
COLIMA_CMD="$COLIMA_CMD --memory $COLIMA_MEMORY"
COLIMA_CMD="$COLIMA_CMD --disk $COLIMA_DISK"
COLIMA_CMD="$COLIMA_CMD --arch $COLIMA_ARCH"
COLIMA_CMD="$COLIMA_CMD --runtime $COLIMA_RUNTIME"
COLIMA_CMD="$COLIMA_CMD --cpu-type $COLIMA_CPU_TYPE"
COLIMA_CMD="$COLIMA_CMD --profile $COLIMA_PROFILE"

# Add Kubernetes flag if enabled
if [ "$COLIMA_KUBERNETES" = "true" ]; then
  COLIMA_CMD="$COLIMA_CMD --kubernetes"
  echo "Kubernetes enabled - kubeconfig will be available at ~/.colima/$COLIMA_PROFILE/kubeconfig"
fi

COLIMA_CMD="$COLIMA_CMD --foreground"

eval $COLIMA_CMD
'''
colima.is-daemon = false
colima.shutdown.command = "colima stop --profile $COLIMA_PROFILE"

[options]
systems = [
  "aarch64-darwin",
  "aarch64-linux",
  "x86_64-darwin",
  "x86_64-linux",
]
