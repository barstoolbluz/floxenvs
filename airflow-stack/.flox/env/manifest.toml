version = 1

[install]
# For helpf documentation viewer
bat.pkg-path = "bat"
curl.pkg-path = "curl"

[include]
environments = [
  # FloxHub Airflow environments
  { remote = "barstoolbluz/airflow-local-dev" },
  { remote = "barstoolbluz/airflow-k8s-executor" },

  # Note: postgres-headless, redis-headless, and kind-headless
  # are already included by the above environments
]

[hook]
on-activate = '''
# === ENTERPRISE-GRADE OVERRIDES ===

# Force CeleryExecutor for distributed task execution
export AIRFLOW_EXECUTOR="CeleryExecutor"

# Production database name
export AIRFLOW_POSTGRES_DB="airflow_prod"

# === OVERRIDE POSTGRES FOR PRODUCTION ===
export POSTGRES_MAX_CONNECTIONS="200"
export POSTGRES_SHARED_BUFFERS="512MB"
export POSTGRES_WORK_MEM="8MB"
export POSTGRES_EFFECTIVE_CACHE_SIZE="8GB"
export POSTGRES_FSYNC="on"  # Data safety - DO NOT DISABLE

# === OVERRIDE REDIS FOR PRODUCTION ===
export REDIS_MAXMEMORY="1gb"
export REDIS_APPENDONLY="yes"  # Enable AOF persistence
export REDIS_APPENDFSYNC="everysec"

# === INCREASE CELERY WORKERS FOR PRODUCTION ===
export AIRFLOW_CELERY_WORKERS="4"
export AIRFLOW__CELERY__WORKER_CONCURRENCY="32"

# === WEBSERVER CONFIGURATION ===
export AIRFLOW_WEBSERVER_WORKERS="8"

# Display enterprise stack info
echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   ðŸš€  Apache Airflow Enterprise Stack                  â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Services:"
echo "  âœ“ PostgreSQL (postgres-headless)"
echo "  âœ“ Redis (redis-headless)"
echo "  âœ“ KIND Cluster (kind-headless)"
echo "  âœ“ Airflow Webserver"
echo "  âœ“ Airflow Scheduler"
echo "  âœ“ Airflow Celery Workers ($AIRFLOW_CELERY_WORKERS)"
echo ""
echo "Configuration:"
echo "  Executor: CeleryExecutor"
echo "  Database: PostgreSQL ($POSTGRES_MAX_CONNECTIONS max connections)"
echo "  Message Broker: Redis (${REDIS_MAXMEMORY}, AOF persistence)"
echo "  Kubernetes: Enabled (KubernetesPodOperator available)"
echo ""
echo "Access:"
echo "  Airflow UI: http://localhost:$AIRFLOW_WEBSERVER_PORT"
echo "  Username: $AIRFLOW_ADMIN_USER"
echo "  Password: $AIRFLOW_ADMIN_PASSWORD"
echo ""
echo "Commands:"
echo "  flox activate -s        Start all services"
echo "  airflow-info            Airflow configuration"
echo "  postgres-info           PostgreSQL configuration"
echo "  redis-info              Redis configuration"
echo "  k8s-airflow-info        Kubernetes configuration"
echo "  helpf                   View environment documentation"
echo ""

fi

  # Fetch README.md if not present
  README_FILE="$FLOX_ENV_PROJECT/README.md"
  if [ ! -f "$README_FILE" ]; then
    if curl -fsSL https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/airflow-stack/README.md -o "$README_FILE" 2>/dev/null; then
      echo "âœ“ Downloaded README.md (use 'helpf' to view)"
    fi
  fi
'''

[profile]
bash = '''
  helpf() {
    local README_FILE="$FLOX_ENV_PROJECT/README.md"
    local README_URL="https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/airflow-stack/README.md"

    if [ "$1" = "--help" ]; then
      echo "Usage: helpf [OPTIONS]"
      echo ""
      echo "View environment documentation"
      echo ""
      echo "Options:"
      echo "  --force    Force download fresh copy from GitHub"
      echo "  --help     Show this help message"
      echo ""
      echo "The README is cached locally and only downloaded if missing."
      return 0
    fi

    if [ "$1" = "--force" ]; then
      echo "Fetching latest README.md from GitHub..."
      if curl -fsSL "$README_URL" -o "$README_FILE"; then
        echo "âœ“ Downloaded README.md"
      else
        echo "âœ— Failed to download README.md"
        return 1
      fi
    elif [ ! -f "$README_FILE" ]; then
      echo "README.md not found, downloading..."
      if curl -fsSL "$README_URL" -o "$README_FILE"; then
        echo "âœ“ Downloaded README.md"
      else
        echo "âœ— Failed to download README.md"
        return 1
      fi
    fi

    if [ -f "$README_FILE" ]; then
      bat --style=auto --paging=always "$README_FILE"
    else
      echo "âœ— README.md not found at $README_FILE"
      return 1
    fi
  }
  export -f helpf
'''

zsh = '''
  helpf() {
    local README_FILE="$FLOX_ENV_PROJECT/README.md"
    local README_URL="https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/airflow-stack/README.md"

    if [ "$1" = "--help" ]; then
      echo "Usage: helpf [OPTIONS]"
      echo ""
      echo "View environment documentation"
      echo ""
      echo "Options:"
      echo "  --force    Force download fresh copy from GitHub"
      echo "  --help     Show this help message"
      echo ""
      echo "The README is cached locally and only downloaded if missing."
      return 0
    fi

    if [ "$1" = "--force" ]; then
      echo "Fetching latest README.md from GitHub..."
      if curl -fsSL "$README_URL" -o "$README_FILE"; then
        echo "âœ“ Downloaded README.md"
      else
        echo "âœ— Failed to download README.md"
        return 1
      fi
    elif [ ! -f "$README_FILE" ]; then
      echo "README.md not found, downloading..."
      if curl -fsSL "$README_URL" -o "$README_FILE"; then
        echo "âœ“ Downloaded README.md"
      else
        echo "âœ— Failed to download README.md"
        return 1
      fi
    fi

    if [ -f "$README_FILE" ]; then
      bat --style=auto --paging=always "$README_FILE"
    else
      echo "âœ— README.md not found at $README_FILE"
      return 1
    fi
  }
'''

fish = '''
function helpf
    set README_FILE "$FLOX_ENV_PROJECT/README.md"
    set README_URL "https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/airflow-stack/README.md"

    if test "$argv[1]" = "--help"
        echo "Usage: helpf [OPTIONS]"
        echo ""
        echo "View environment documentation"
        echo ""
        echo "Options:"
        echo "  --force    Force download fresh copy from GitHub"
        echo "  --help     Show this help message"
        echo ""
        echo "The README is cached locally and only downloaded if missing."
        return 0
    end

    if test "$argv[1]" = "--force"
        echo "Fetching latest README.md from GitHub..."
        if curl -fsSL "$README_URL" -o "$README_FILE"
            echo "âœ“ Downloaded README.md"
        else
            echo "âœ— Failed to download README.md"
            return 1
        end
    else if not test -f "$README_FILE"
        echo "README.md not found, downloading..."
        if curl -fsSL "$README_URL" -o "$README_FILE"
            echo "âœ“ Downloaded README.md"
        else
            echo "âœ— Failed to download README.md"
            return 1
        end
    end

    if test -f "$README_FILE"
        bat --style=auto --paging=always "$README_FILE"
    else
        echo "âœ— README.md not found at $README_FILE"
        return 1
    end
end
'''

[options]
systems = [
  "aarch64-darwin",
  "aarch64-linux",
  "x86_64-darwin",
  "x86_64-linux",
]
