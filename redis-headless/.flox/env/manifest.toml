version = 1

[install]
redis.pkg-path = "redis"

[vars]
# Base configuration paths (invariant)
REDIS_CONFIG_DIR = "$FLOX_ENV_CACHE/redis-config"
REDIS_LOG_DIR = "$FLOX_ENV_CACHE/redis-logs"
REDIS_DATA_DIR = "$FLOX_ENV_CACHE/redis-data"

[hook]
on-activate = '''
# Create required directories
mkdir -p "$FLOX_ENV_CACHE/redis-config"
mkdir -p "$FLOX_ENV_CACHE/redis-logs"
mkdir -p "$FLOX_ENV_CACHE/redis-data"

# === RUNTIME VARIABLES - Connection ===
export REDIS_HOST="${REDIS_HOST:-127.0.0.1}"
export REDIS_PORT="${REDIS_PORT:-16379}"
export REDIS_PASSWORD="${REDIS_PASSWORD:-}"

# === RUNTIME VARIABLES - Memory Management ===
export REDIS_MAXMEMORY="${REDIS_MAXMEMORY:-256mb}"
export REDIS_MAXMEMORY_POLICY="${REDIS_MAXMEMORY_POLICY:-noeviction}"
export REDIS_MAXMEMORY_SAMPLES="${REDIS_MAXMEMORY_SAMPLES:-5}"

# === RUNTIME VARIABLES - Persistence (RDB) ===
export REDIS_SAVE_RDB="${REDIS_SAVE_RDB:-yes}"
export REDIS_SAVE_900="${REDIS_SAVE_900:-1}"
export REDIS_SAVE_300="${REDIS_SAVE_300:-10}"
export REDIS_SAVE_60="${REDIS_SAVE_60:-10000}"
export REDIS_RDB_COMPRESSION="${REDIS_RDB_COMPRESSION:-yes}"
export REDIS_RDB_CHECKSUM="${REDIS_RDB_CHECKSUM:-yes}"

# === RUNTIME VARIABLES - Persistence (AOF) ===
export REDIS_APPENDONLY="${REDIS_APPENDONLY:-no}"
export REDIS_APPENDFSYNC="${REDIS_APPENDFSYNC:-everysec}"
export REDIS_AOF_REWRITE_PERCENTAGE="${REDIS_AOF_REWRITE_PERCENTAGE:-100}"
export REDIS_AOF_REWRITE_MIN_SIZE="${REDIS_AOF_REWRITE_MIN_SIZE:-64mb}"

# === RUNTIME VARIABLES - Performance ===
export REDIS_DATABASES="${REDIS_DATABASES:-16}"
export REDIS_TCP_BACKLOG="${REDIS_TCP_BACKLOG:-511}"
export REDIS_TIMEOUT="${REDIS_TIMEOUT:-0}"
export REDIS_TCP_KEEPALIVE="${REDIS_TCP_KEEPALIVE:-300}"
export REDIS_MAXCLIENTS="${REDIS_MAXCLIENTS:-10000}"

# === RUNTIME VARIABLES - Slow Log ===
export REDIS_SLOWLOG_LOG_SLOWER_THAN="${REDIS_SLOWLOG_LOG_SLOWER_THAN:-10000}"
export REDIS_SLOWLOG_MAX_LEN="${REDIS_SLOWLOG_MAX_LEN:-128}"

# === RUNTIME VARIABLES - Latency Monitor ===
export REDIS_LATENCY_MONITOR_THRESHOLD="${REDIS_LATENCY_MONITOR_THRESHOLD:-0}"

# === RUNTIME VARIABLES - Security ===
export REDIS_PROTECTED_MODE="${REDIS_PROTECTED_MODE:-yes}"
export REDIS_RENAME_COMMANDS="${REDIS_RENAME_COMMANDS:-}"

# === FLEXIBILITY ===
export REDIS_EXTRA_OPTS="${REDIS_EXTRA_OPTS:-}"

# === DERIVED VARIABLES ===
export REDIS_DIR="${REDIS_DIR:-$FLOX_ENV_CACHE/redis-data}"
export REDIS_CONF_FILE="$REDIS_CONFIG_DIR/redis.conf"
export REDIS_LOG_FILE="$REDIS_LOG_DIR/redis.log"

# === CONFIGURATION GENERATION ===
generate_redis_config() {
    # Ensure directories exist
    mkdir -p "$REDIS_DIR" "$REDIS_CONFIG_DIR" "$REDIS_LOG_DIR"
    chmod 700 "$REDIS_DIR" "$REDIS_CONFIG_DIR"

    cat > "$REDIS_CONF_FILE" << EOF
# Redis configuration generated by Flox (headless mode)
# Connection
bind $REDIS_HOST
port $REDIS_PORT
protected-mode $REDIS_PROTECTED_MODE

# General
daemonize no
dir $REDIS_DIR
logfile $REDIS_LOG_FILE
databases $REDIS_DATABASES

# Network
tcp-backlog $REDIS_TCP_BACKLOG
timeout $REDIS_TIMEOUT
tcp-keepalive $REDIS_TCP_KEEPALIVE

# Clients
maxclients $REDIS_MAXCLIENTS

# Memory Management
maxmemory $REDIS_MAXMEMORY
maxmemory-policy $REDIS_MAXMEMORY_POLICY
maxmemory-samples $REDIS_MAXMEMORY_SAMPLES

EOF

    # Add password if set
    if [ -n "$REDIS_PASSWORD" ]; then
        echo "# Security" >> "$REDIS_CONF_FILE"
        echo "requirepass $REDIS_PASSWORD" >> "$REDIS_CONF_FILE"
        echo "" >> "$REDIS_CONF_FILE"
    fi

    # Add command renaming if set
    if [ -n "$REDIS_RENAME_COMMANDS" ]; then
        echo "# Command renaming" >> "$REDIS_CONF_FILE"
        # Format: "FLUSHDB,FLUSHALL,CONFIG" -> rename-command FLUSHDB "", rename-command FLUSHALL ""
        IFS=',' read -ra CMDS <<< "$REDIS_RENAME_COMMANDS"
        for cmd in "${CMDS[@]}"; do
            echo "rename-command $cmd \"\"" >> "$REDIS_CONF_FILE"
        done
        echo "" >> "$REDIS_CONF_FILE"
    fi

    # RDB Persistence
    echo "# RDB Persistence" >> "$REDIS_CONF_FILE"
    if [ "$REDIS_SAVE_RDB" = "yes" ]; then
        echo "save 900 $REDIS_SAVE_900" >> "$REDIS_CONF_FILE"
        echo "save 300 $REDIS_SAVE_300" >> "$REDIS_CONF_FILE"
        echo "save 60 $REDIS_SAVE_60" >> "$REDIS_CONF_FILE"
        echo "rdbcompression $REDIS_RDB_COMPRESSION" >> "$REDIS_CONF_FILE"
        echo "rdbchecksum $REDIS_RDB_CHECKSUM" >> "$REDIS_CONF_FILE"
    else
        echo "save \"\"" >> "$REDIS_CONF_FILE"
    fi
    echo "" >> "$REDIS_CONF_FILE"

    # AOF Persistence
    echo "# AOF Persistence" >> "$REDIS_CONF_FILE"
    echo "appendonly $REDIS_APPENDONLY" >> "$REDIS_CONF_FILE"
    if [ "$REDIS_APPENDONLY" = "yes" ]; then
        echo "appendfsync $REDIS_APPENDFSYNC" >> "$REDIS_CONF_FILE"
        echo "auto-aof-rewrite-percentage $REDIS_AOF_REWRITE_PERCENTAGE" >> "$REDIS_CONF_FILE"
        echo "auto-aof-rewrite-min-size $REDIS_AOF_REWRITE_MIN_SIZE" >> "$REDIS_CONF_FILE"
    fi
    echo "" >> "$REDIS_CONF_FILE"

    # Slow Log
    echo "# Slow Log" >> "$REDIS_CONF_FILE"
    echo "slowlog-log-slower-than $REDIS_SLOWLOG_LOG_SLOWER_THAN" >> "$REDIS_CONF_FILE"
    echo "slowlog-max-len $REDIS_SLOWLOG_MAX_LEN" >> "$REDIS_CONF_FILE"
    echo "" >> "$REDIS_CONF_FILE"

    # Latency Monitor
    echo "# Latency Monitor" >> "$REDIS_CONF_FILE"
    echo "latency-monitor-threshold $REDIS_LATENCY_MONITOR_THRESHOLD" >> "$REDIS_CONF_FILE"

    chmod 644 "$REDIS_CONF_FILE"
    return 0
}

# Generate configuration on activation
generate_redis_config

# Display info with safety warnings
echo ""
echo "✅ Redis environment ready (headless mode)"
echo ""

# Safety warnings
if [ "$REDIS_PROTECTED_MODE" = "no" ]; then
    echo "⚠️  WARNING: Protected mode disabled - EXPOSED TO NETWORK"
fi
if [ -z "$REDIS_PASSWORD" ]; then
    echo "⚠️  WARNING: No password set - UNAUTHENTICATED ACCESS"
fi
if [ "$REDIS_HOST" = "0.0.0.0" ]; then
    echo "⚠️  WARNING: Listening on all interfaces - NETWORK EXPOSED"
fi
if [ "$REDIS_APPENDONLY" = "no" ] && [ "$REDIS_SAVE_RDB" = "no" ]; then
    echo "⚠️  WARNING: All persistence disabled - DATA LOSS ON RESTART"
fi
[ "$REDIS_PROTECTED_MODE" = "no" ] || [ -z "$REDIS_PASSWORD" ] || [ "$REDIS_HOST" = "0.0.0.0" ] || [ "$REDIS_APPENDONLY" = "no" -a "$REDIS_SAVE_RDB" = "no" ] && echo ""

echo "Connection:"
echo "  Host: ${REDIS_HOST}:${REDIS_PORT}"
if [ -n "$REDIS_PASSWORD" ]; then
    echo "  Password: ***"
else
    echo "  Password: (none)"
fi
echo ""
echo "Memory:"
echo "  Max memory: ${REDIS_MAXMEMORY}"
echo "  Eviction policy: ${REDIS_MAXMEMORY_POLICY}"
echo ""
echo "Persistence:"
echo "  RDB snapshots: ${REDIS_SAVE_RDB}"
echo "  AOF logging: ${REDIS_APPENDONLY}"
echo ""
echo "Commands:"
echo "  flox activate -s        Start Redis"
echo "  redis-cli               Connect to Redis"
echo "  redis-info              Show configuration"
echo ""
'''

[services]
redis.command = "redis-server $REDIS_CONF_FILE"

[profile]
bash = '''
redis-info() {
    echo "Redis (Headless Mode) - Configuration"
    echo ""
    echo "Connection:"
    echo "  Host: ${REDIS_HOST}:${REDIS_PORT}"
    if [ -n "$REDIS_PASSWORD" ]; then
        echo "  Password: ***"
    else
        echo "  Password: (none)"
    fi
    echo "  Protected mode: ${REDIS_PROTECTED_MODE}"
    echo ""
    echo "Memory:"
    echo "  Max memory: ${REDIS_MAXMEMORY}"
    echo "  Eviction policy: ${REDIS_MAXMEMORY_POLICY}"
    echo "  Eviction samples: ${REDIS_MAXMEMORY_SAMPLES}"
    echo ""
    echo "Persistence (RDB):"
    echo "  Enabled: ${REDIS_SAVE_RDB}"
    if [ "$REDIS_SAVE_RDB" = "yes" ]; then
        echo "  Save after 900s if ${REDIS_SAVE_900}+ changes"
        echo "  Save after 300s if ${REDIS_SAVE_300}+ changes"
        echo "  Save after 60s if ${REDIS_SAVE_60}+ changes"
        echo "  Compression: ${REDIS_RDB_COMPRESSION}"
        echo "  Checksum: ${REDIS_RDB_CHECKSUM}"
    fi
    echo ""
    echo "Persistence (AOF):"
    echo "  Enabled: ${REDIS_APPENDONLY}"
    if [ "$REDIS_APPENDONLY" = "yes" ]; then
        echo "  Fsync policy: ${REDIS_APPENDFSYNC}"
        echo "  Rewrite percentage: ${REDIS_AOF_REWRITE_PERCENTAGE}"
        echo "  Rewrite min size: ${REDIS_AOF_REWRITE_MIN_SIZE}"
    fi
    echo ""
    echo "Performance:"
    echo "  Databases: ${REDIS_DATABASES}"
    echo "  Max clients: ${REDIS_MAXCLIENTS}"
    echo "  TCP backlog: ${REDIS_TCP_BACKLOG}"
    echo "  Timeout: ${REDIS_TIMEOUT}s"
    echo "  TCP keepalive: ${REDIS_TCP_KEEPALIVE}s"
    echo ""
    echo "Monitoring:"
    echo "  Slow log threshold: ${REDIS_SLOWLOG_LOG_SLOWER_THAN}μs"
    echo "  Slow log max length: ${REDIS_SLOWLOG_MAX_LEN}"
    echo "  Latency monitor threshold: ${REDIS_LATENCY_MONITOR_THRESHOLD}ms"
    echo ""
    echo "Data Directory: ${REDIS_DIR}"
    echo "Config File: ${REDIS_CONF_FILE}"
    echo ""
    echo "Commands:"
    echo "  redis-cli                       Connect to Redis"
    echo "  flox activate -s                Start Redis service"
    echo "  flox services status            Check service status"
    echo "  flox services logs redis        View service logs"
    echo "  flox services restart redis     Restart with new settings"
}
export -f redis-info
'''

zsh = '''
redis-info() {
    echo "Redis (Headless Mode) - Configuration"
    echo ""
    echo "Connection:"
    echo "  Host: ${REDIS_HOST}:${REDIS_PORT}"
    if [ -n "$REDIS_PASSWORD" ]; then
        echo "  Password: ***"
    else
        echo "  Password: (none)"
    fi
    echo "  Protected mode: ${REDIS_PROTECTED_MODE}"
    echo ""
    echo "Memory:"
    echo "  Max memory: ${REDIS_MAXMEMORY}"
    echo "  Eviction policy: ${REDIS_MAXMEMORY_POLICY}"
    echo "  Eviction samples: ${REDIS_MAXMEMORY_SAMPLES}"
    echo ""
    echo "Persistence (RDB):"
    echo "  Enabled: ${REDIS_SAVE_RDB}"
    if [ "$REDIS_SAVE_RDB" = "yes" ]; then
        echo "  Save after 900s if ${REDIS_SAVE_900}+ changes"
        echo "  Save after 300s if ${REDIS_SAVE_300}+ changes"
        echo "  Save after 60s if ${REDIS_SAVE_60}+ changes"
        echo "  Compression: ${REDIS_RDB_COMPRESSION}"
        echo "  Checksum: ${REDIS_RDB_CHECKSUM}"
    fi
    echo ""
    echo "Persistence (AOF):"
    echo "  Enabled: ${REDIS_APPENDONLY}"
    if [ "$REDIS_APPENDONLY" = "yes" ]; then
        echo "  Fsync policy: ${REDIS_APPENDFSYNC}"
        echo "  Rewrite percentage: ${REDIS_AOF_REWRITE_PERCENTAGE}"
        echo "  Rewrite min size: ${REDIS_AOF_REWRITE_MIN_SIZE}"
    fi
    echo ""
    echo "Performance:"
    echo "  Databases: ${REDIS_DATABASES}"
    echo "  Max clients: ${REDIS_MAXCLIENTS}"
    echo "  TCP backlog: ${REDIS_TCP_BACKLOG}"
    echo "  Timeout: ${REDIS_TIMEOUT}s"
    echo "  TCP keepalive: ${REDIS_TCP_KEEPALIVE}s"
    echo ""
    echo "Monitoring:"
    echo "  Slow log threshold: ${REDIS_SLOWLOG_LOG_SLOWER_THAN}μs"
    echo "  Slow log max length: ${REDIS_SLOWLOG_MAX_LEN}"
    echo "  Latency monitor threshold: ${REDIS_LATENCY_MONITOR_THRESHOLD}ms"
    echo ""
    echo "Data Directory: ${REDIS_DIR}"
    echo "Config File: ${REDIS_CONF_FILE}"
    echo ""
    echo "Commands:"
    echo "  redis-cli                       Connect to Redis"
    echo "  flox activate -s                Start Redis service"
    echo "  flox services status            Check service status"
    echo "  flox services logs redis        View service logs"
    echo "  flox services restart redis     Restart with new settings"
}
'''

fish = '''
function redis-info
    echo "Redis (Headless Mode) - Configuration"
    echo ""
    echo "Connection:"
    echo "  Host: $REDIS_HOST:$REDIS_PORT"
    if test -n "$REDIS_PASSWORD"
        echo "  Password: ***"
    else
        echo "  Password: (none)"
    end
    echo "  Protected mode: $REDIS_PROTECTED_MODE"
    echo ""
    echo "Memory:"
    echo "  Max memory: $REDIS_MAXMEMORY"
    echo "  Eviction policy: $REDIS_MAXMEMORY_POLICY"
    echo "  Eviction samples: $REDIS_MAXMEMORY_SAMPLES"
    echo ""
    echo "Persistence (RDB):"
    echo "  Enabled: $REDIS_SAVE_RDB"
    if test "$REDIS_SAVE_RDB" = "yes"
        echo "  Save after 900s if $REDIS_SAVE_900+ changes"
        echo "  Save after 300s if $REDIS_SAVE_300+ changes"
        echo "  Save after 60s if $REDIS_SAVE_60+ changes"
        echo "  Compression: $REDIS_RDB_COMPRESSION"
        echo "  Checksum: $REDIS_RDB_CHECKSUM"
    end
    echo ""
    echo "Persistence (AOF):"
    echo "  Enabled: $REDIS_APPENDONLY"
    if test "$REDIS_APPENDONLY" = "yes"
        echo "  Fsync policy: $REDIS_APPENDFSYNC"
        echo "  Rewrite percentage: $REDIS_AOF_REWRITE_PERCENTAGE"
        echo "  Rewrite min size: $REDIS_AOF_REWRITE_MIN_SIZE"
    end
    echo ""
    echo "Performance:"
    echo "  Databases: $REDIS_DATABASES"
    echo "  Max clients: $REDIS_MAXCLIENTS"
    echo "  TCP backlog: $REDIS_TCP_BACKLOG"
    echo "  Timeout: $REDIS_TIMEOUT"s
    echo "  TCP keepalive: $REDIS_TCP_KEEPALIVE"s
    echo ""
    echo "Monitoring:"
    echo "  Slow log threshold: $REDIS_SLOWLOG_LOG_SLOWER_THAN"μs
    echo "  Slow log max length: $REDIS_SLOWLOG_MAX_LEN"
    echo "  Latency monitor threshold: $REDIS_LATENCY_MONITOR_THRESHOLD"ms
    echo ""
    echo "Data Directory: $REDIS_DIR"
    echo "Config File: $REDIS_CONF_FILE"
    echo ""
    echo "Commands:"
    echo "  redis-cli                       Connect to Redis"
    echo "  flox activate -s                Start Redis service"
    echo "  flox services status            Check service status"
    echo "  flox services logs redis        View service logs"
    echo "  flox services restart redis     Restart with new settings"
end
'''

[options]
systems = [
  "aarch64-darwin",
  "aarch64-linux",
  "x86_64-darwin",
  "x86_64-linux",
]
